<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>宾客座位规划系统</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/supabase@2.31.0/dist/umd/supabase.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#F59E0B',
            neutral: '#1F2937',
            'neutral-light': '#F3F4F6',
            danger: '#EF4444',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .transition-height {
        transition: max-height 0.3s ease-in-out;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans text-neutral overflow-hidden h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white border-b border-gray-200 shadow-sm z-30">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <!-- 标题和logo -->
      <div class="flex items-center space-x-3">
        <div class="text-primary text-2xl">
          <i class="fa fa-users"></i>
        </div>
        <h1 class="text-xl font-bold text-neutral">宾客座位规划系统</h1>
        <span id="online-indicator" class="hidden md:flex items-center text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">
          <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
          <span id="online-count">0</span>人在线
        </span>
      </div>
      
      <!-- 操作按钮区 -->
      <div class="flex items-center space-x-2 md:space-x-4">
        <button id="save-btn" class="hidden md:flex items-center text-sm bg-primary hover:bg-primary/90 text-white px-3 py-1.5 rounded-md transition-all duration-200">
          <i class="fa fa-save mr-1.5"></i> 保存
        </button>
        <button id="export-btn" class="hidden md:flex items-center text-sm bg-gray-700 hover:bg-gray-800 text-white px-3 py-1.5 rounded-md transition-all duration-200">
          <i class="fa fa-download mr-1.5"></i> 导出
        </button>
        <button id="print-btn" class="hidden md:flex items-center text-sm bg-gray-700 hover:bg-gray-800 text-white px-3 py-1.5 rounded-md transition-all duration-200">
          <i class="fa fa-print mr-1.5"></i> 打印
        </button>
        <button id="share-btn" class="hidden md:flex items-center text-sm bg-accent hover:bg-accent/90 text-white px-3 py-1.5 rounded-md transition-all duration-200">
          <i class="fa fa-share-alt mr-1.5"></i> 分享
        </button>
        
        <!-- 移动端菜单按钮 -->
        <button id="mobile-menu-btn" class="md:hidden text-neutral hover:text-primary transition-colors">
          <i class="fa fa-ellipsis-v text-xl"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex flex-1 overflow-hidden">
    <!-- 左侧功能栏 -->
    <aside id="sidebar" class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col h-full transition-all duration-300 z-20">
      <!-- 计划信息 -->
      <div class="p-4 border-b border-gray-200">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-lg font-semibold text-neutral">计划信息</h2>
          <button id="edit-plan-btn" class="text-primary hover:text-primary/80 text-sm transition-colors">
            <i class="fa fa-pencil"></i>
          </button>
        </div>
        <div class="text-sm text-gray-600">
          <p>计划ID: <span id="plan-id" class="font-mono truncate">loading...</span></p>
          <p class="mt-1">更新于: <span id="last-updated">刚刚</span></p>
        </div>
      </div>
      
      <!-- 宾客管理 -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <div class="p-3 border-b border-gray-200 flex justify-between items-center">
          <h3 class="font-medium text-neutral flex items-center">
            <i class="fa fa-user-circle text-primary mr-2"></i>
            宾客管理
          </h3>
          <span id="guest-count" class="bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded-full">0人</span>
        </div>
        
        <!-- 宾客搜索和添加 -->
        <div class="p-3 border-b border-gray-200">
          <div class="relative mb-2">
            <input 
              type="text" 
              id="guest-search" 
              placeholder="搜索宾客..." 
              class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
            >
            <i class="fa fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          
          <div class="flex space-x-2">
            <div class="relative flex-1">
              <input 
                type="text" 
                id="new-guest" 
                placeholder="添加宾客（格式：姓名 人数[可选](分类[可选])）" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
              >
              <div class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-500">
                例：张三 2(家人)
              </div>
            </div>
            <button id="add-guest-btn" class="bg-primary hover:bg-primary/90 text-white p-2 rounded-md transition-all">
              <i class="fa fa-plus"></i>
            </button>
          </div>
          
          <button id="batch-add-btn" class="w-full mt-2 text-sm text-primary hover:text-primary/80 transition-colors">
            <i class="fa fa-list-alt mr-1"></i> 批量添加
          </button>
        </div>
        
        <!-- 宾客分类筛选 -->
        <div class="p-2 border-b border-gray-200 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-1 min-w-max">
            <button class="filter-btn active px-3 py-1 bg-primary text-white text-xs rounded-full transition-all">
              全部
            </button>
            <button class="filter-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded-full transition-all">
              家人
            </button>
            <button class="filter-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded-full transition-all">
              朋友
            </button>
            <button class="filter-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded-full transition-all">
              同事
            </button>
            <button class="filter-btn px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded-full transition-all">
              其他
            </button>
          </div>
        </div>
        
        <!-- 宾客列表（带滚动） -->
        <div class="flex-1 overflow-y-auto scrollbar-hide p-2" id="guest-list-container">
          <div id="guest-list" class="space-y-1.5">
            <!-- 宾客项示例 -->
            <div class="guest-item bg-gray-50 hover:bg-gray-100 p-2 rounded-md text-sm cursor-move transition-all border border-gray-200 hover:border-primary/30 flex justify-between items-center group">
              <div>
                <div class="font-medium">张三</div>
                <div class="text-xs text-gray-500">2人 · 家人</div>
              </div>
              <button class="text-gray-400 hover:text-danger opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <div class="guest-item bg-gray-50 hover:bg-gray-100 p-2 rounded-md text-sm cursor-move transition-all border border-gray-200 hover:border-primary/30 flex justify-between items-center group">
              <div>
                <div class="font-medium">李四</div>
                <div class="text-xs text-gray-500">1人 · 朋友</div>
              </div>
              <button class="text-gray-400 hover:text-danger opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <div class="guest-item bg-gray-50 hover:bg-gray-100 p-2 rounded-md text-sm cursor-move transition-all border border-gray-200 hover:border-primary/30 flex justify-between items-center group">
              <div>
                <div class="font-medium">王五</div>
                <div class="text-xs text-gray-500">3人 · 同事</div>
              </div>
              <button class="text-gray-400 hover:text-danger opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 更多宾客项将通过JS动态添加 -->
          </div>
          
          <!-- 空状态提示 -->
          <div id="empty-guest-state" class="hidden flex flex-col items-center justify-center h-full text-gray-400 p-6">
            <i class="fa fa-user-o text-4xl mb-3"></i>
            <p class="text-center">暂无宾客，请添加宾客</p>
          </div>
        </div>
        
        <!-- 底部操作按钮 -->
        <div class="p-3 border-t border-gray-200 bg-gray-50">
          <button id="clear-unassigned-btn" class="w-full text-sm text-gray-600 hover:text-danger transition-colors py-1.5">
            <i class="fa fa-trash-o mr-1"></i> 清空未入座宾客
          </button>
        </div>
      </div>
    </aside>

    <!-- 右侧主区域 -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- 操作工具栏 -->
      <div class="bg-white border-b border-gray-200 p-3 flex flex-wrap items-center justify-between gap-2">
        <div class="flex flex-wrap items-center gap-2">
          <button id="add-table-btn" class="flex items-center text-sm bg-secondary hover:bg-secondary/90 text-white px-3 py-1.5 rounded-md transition-all duration-200">
            <i class="fa fa-plus-circle mr-1.5"></i> 添加桌位
          </button>
          <button id="auto-arrange-btn" class="flex items-center text-sm bg-accent hover:bg-accent/90 text-white px-3 py-1.5 rounded-md transition-all duration-200">
            <i class="fa fa-magic mr-1.5"></i> 自动排座
          </button>
          
          <div class="flex items-center border border-gray-300 rounded-md overflow-hidden">
            <button id="zoom-out-btn" class="text-gray-600 hover:bg-gray-100 px-2 py-1.5 text-sm transition-colors">
              <i class="fa fa-search-minus"></i>
            </button>
            <div class="border-x border-gray-300 h-6"></div>
            <button id="zoom-reset-btn" class="text-gray-600 hover:bg-gray-100 px-2 py-1.5 text-sm transition-colors">
              100%
            </button>
            <div class="border-x border-gray-300 h-6"></div>
            <button id="zoom-in-btn" class="text-gray-600 hover:bg-gray-100 px-2 py-1.5 text-sm transition-colors">
              <i class="fa fa-search-plus"></i>
            </button>
          </div>
        </div>
        
        <div class="flex items-center gap-2">
          <div class="text-sm text-gray-600">
            总桌位: <span id="total-tables">0</span> | 总人数: <span id="total-people">0</span>
          </div>
          <button id="reset-all-btn" class="flex items-center text-sm text-danger hover:text-danger/80 px-3 py-1.5 rounded-md transition-all duration-200">
            <i class="fa fa-refresh mr-1.5"></i> 重置全部
          </button>
        </div>
      </div>
      
      <!-- 桌位布局区域 -->
      <div class="flex-1 overflow-auto bg-gray-100 p-4" id="table-container">
        <div id="table-area" class="min-h-full min-w-full">
          <!-- 桌位示例 -->
          <div class="table-item absolute bg-white rounded-lg shadow-card hover:shadow-card-hover border-2 border-gray-200 hover:border-primary transition-all duration-200 p-2 w-48" style="left: 50px; top: 50px;">
            <div class="flex justify-between items-center mb-1">
              <div class="font-medium text-sm">主桌</div>
              <div class="text-xs text-gray-500">8人</div>
            </div>
            <div class="text-xs text-gray-600 max-h-32 overflow-y-auto scrollbar-hide">
              <div class="flex justify-between items-center py-0.5 border-b border-gray-100">
                <span>张三 (2人)</span>
                <button class="text-gray-400 hover:text-danger text-xs">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
            <div class="mt-1 flex justify-end gap-1">
              <button class="table-edit-btn text-gray-400 hover:text-primary text-xs p-1" title="编辑">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="table-clear-btn text-gray-400 hover:text-gray-600 text-xs p-1" title="清空">
                <i class="fa fa-trash-o"></i>
              </button>
              <button class="table-delete-btn text-gray-400 hover:text-danger text-xs p-1" title="删除">
                <i class="fa fa-remove"></i>
              </button>
            </div>
          </div>
          
          <div class="table-item absolute bg-white rounded-lg shadow-card hover:shadow-card-hover border-2 border-gray-200 hover:border-primary transition-all duration-200 p-2 w-48" style="left: 250px; top: 50px;">
            <div class="flex justify-between items-center mb-1">
              <div class="font-medium text-sm">1号桌</div>
              <div class="text-xs text-gray-500">6人</div>
            </div>
            <div class="text-xs text-gray-600 max-h-32 overflow-y-auto scrollbar-hide">
              <div class="flex justify-between items-center py-0.5 border-b border-gray-100">
                <span>李四 (1人)</span>
                <button class="text-gray-400 hover:text-danger text-xs">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
            <div class="mt-1 flex justify-end gap-1">
              <button class="table-edit-btn text-gray-400 hover:text-primary text-xs p-1" title="编辑">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="table-clear-btn text-gray-400 hover:text-gray-600 text-xs p-1" title="清空">
                <i class="fa fa-trash-o"></i>
              </button>
              <button class="table-delete-btn text-gray-400 hover:text-danger text-xs p-1" title="删除">
                <i class="fa fa-remove"></i>
              </button>
            </div>
          </div>
          
          <!-- 占位桌示例 -->
          <div class="table-item placeholder-table absolute bg-white/30 rounded-lg border-2 border-dashed border-gray-400 p-2 w-48" style="left: 450px; top: 50px;">
            <div class="text-center text-gray-500 text-sm font-medium">占位桌（不可用）</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 模态框：批量添加宾客 -->
  <div id="batch-add-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="font-semibold text-lg">批量添加宾客</h3>
        <button id="close-batch-modal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <p class="text-sm text-gray-600 mb-3">每行添加一位宾客，格式：姓名 [人数(可选)] (分类(可选))</p>
        <textarea 
          id="batch-guests" 
          class="w-full border border-gray-300 rounded-md p-3 h-40 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
          placeholder="例如：
张三 2(家人)
李四 (朋友)
王五 3
赵六"
        ></textarea>
      </div>
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button id="confirm-batch-add" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md transition-colors">
          确认添加
        </button>
      </div>
    </div>
  </div>

  <!-- 模态框：添加/编辑桌位 -->
  <div id="table-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 id="table-modal-title" class="font-semibold text-lg">添加桌位</h3>
        <button id="close-table-modal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <label for="table-name" class="block text-sm font-medium text-gray-700 mb-1">桌位名称</label>
          <input 
            type="text" 
            id="table-name" 
            class="w-full border border-gray-300 rounded-md p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            placeholder="例如：1号桌、主桌"
          >
        </div>
        <div>
          <label for="table-capacity" class="block text-sm font-medium text-gray-700 mb-1">容纳人数</label>
          <input 
            type="number" 
            id="table-capacity" 
            min="1" 
            class="w-full border border-gray-300 rounded-md p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            placeholder="请输入桌位可容纳人数"
          >
        </div>
      </div>
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button id="confirm-table" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md transition-colors">
          确认
        </button>
      </div>
    </div>
  </div>

  <!-- 模态框：自动排座设置 -->
  <div id="arrange-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="font-semibold text-lg">自动排座设置</h3>
        <button id="close-arrange-modal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <div class="flex items-center mb-3">
          <input type="checkbox" id="group-by-category" class="mr-2 h-4 w-4 text-primary focus:ring-primary/50 border-gray-300 rounded">
          <label for="group-by-category" class="text-sm text-gray-700">按类别分组排座</label>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="optimize-utilization" class="mr-2 h-4 w-4 text-primary focus:ring-primary/50 border-gray-300 rounded">
          <label for="optimize-utilization" class="text-sm text-gray-700">优化座位利用率</label>
        </div>
      </div>
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button id="confirm-arrange" class="bg-accent hover:bg-accent/90 text-white px-4 py-2 rounded-md transition-colors">
          开始排座
        </button>
      </div>
    </div>
  </div>

  <!-- 模态框：分享链接 -->
  <div id="share-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="font-semibold text-lg">分享计划</h3>
        <button id="close-share-modal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <p class="text-sm text-gray-600 mb-3">复制链接分享给他人，共同编辑此座位计划</p>
        <div class="flex">
          <input 
            type="text" 
            id="share-link" 
            class="flex-1 border border-gray-300 rounded-l-md p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            readonly
          >
          <button id="copy-link-btn" class="bg-primary hover:bg-primary/90 text-white px-3 py-2.5 rounded-r-md transition-colors">
            复制
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 移动端菜单 -->
  <div id="mobile-menu" class="fixed inset-0 bg-black/50 z-40 hidden">
    <div class="absolute right-0 top-0 bottom-0 w-64 bg-white shadow-lg transform transition-transform duration-300">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="font-semibold">菜单</h3>
        <button id="close-mobile-menu" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-2">
        <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-md transition-colors flex items-center">
          <i class="fa fa-save w-5 text-primary mr-2"></i> 保存
        </button>
        <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-md transition-colors flex items-center">
          <i class="fa fa-download w-5 text-gray-700 mr-2"></i> 导出
        </button>
        <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-md transition-colors flex items-center">
          <i class="fa fa-print w-5 text-gray-700 mr-2"></i> 打印
        </button>
        <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-md transition-colors flex items-center">
          <i class="fa fa-share-alt w-5 text-accent mr-2"></i> 分享
        </button>
        <div class="border-t border-gray-200 my-2"></div>
        <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-md transition-colors flex items-center text-danger">
          <i class="fa fa-refresh w-5 mr-2"></i> 重置全部
        </button>
      </div>
    </div>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-md shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
    <i id="notification-icon" class="fa fa-check-circle text-green-400 mr-2"></i>
    <span id="notification-message">操作成功</span>
  </div>

  <!-- 确认对话框 -->
  <div id="confirm-dialog" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-4 border-b border-gray-200">
        <h3 id="confirm-title" class="font-semibold text-lg">确认操作</h3>
      </div>
      <div class="p-4">
        <p id="confirm-message" class="text-gray-600">您确定要执行此操作吗？</p>
      </div>
      <div class="p-4 border-t border-gray-200 flex justify-end space-x-2">
        <button id="cancel-confirm" class="border border-gray-300 hover:bg-gray-100 text-gray-700 px-4 py-2 rounded-md transition-colors">
          取消
        </button>
        <button id="accept-confirm" class="bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-md transition-colors">
          确认
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript 代码 -->
  <script>
    // 初始化Supabase客户端
    const supabaseUrl = 'https://your-project-id.supabase.co';
    const supabaseKey = 'your-anon-key';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // 全局状态管理
    const state = {
      planId: null,
      guests: [],
      tables: [],
      onlineUsers: 0,
      isDragging: false,
      draggedGuest: null,
      zoomLevel: 100,
    };
    
    // DOM元素引用
    const elements = {
      guestList: document.getElementById('guest-list'),
      guestListContainer: document.getElementById('guest-list-container'),
      guestCount: document.getElementById('guest-count'),
      emptyGuestState: document.getElementById('empty-guest-state'),
      tableArea: document.getElementById('table-area'),
      totalTables: document.getElementById('total-tables'),
      totalPeople: document.getElementById('total-people'),
      planIdDisplay: document.getElementById('plan-id'),
      onlineCount: document.getElementById('online-count'),
      
      // 模态框
      batchAddModal: document.getElementById('batch-add-modal'),
      tableModal: document.getElementById('table-modal'),
      arrangeModal: document.getElementById('arrange-modal'),
      shareModal: document.getElementById('share-modal'),
      mobileMenu: document.getElementById('mobile-menu'),
      confirmDialog: document.getElementById('confirm-dialog'),
      
      // 通知
      notification: document.getElementById('notification'),
      notificationIcon: document.getElementById('notification-icon'),
      notificationMessage: document.getElementById('notification-message'),
    };
    
    // 初始化应用
    async function initApp() {
      // 从URL获取或创建计划ID
      await initializePlanId();
      
      // 加载数据
      await loadData();
      
      // 设置事件监听器
      setupEventListeners();
      
      // 初始化协作功能
      setupCollaboration();
      
      // 检查并显示空状态
      checkEmptyStates();
    }
    
    // 从URL获取或创建计划ID
    async function initializePlanId() {
      const urlParams = new URLSearchParams(window.location.search);
      let planId = urlParams.get('plan');
      
      if (planId) {
        // 验证计划ID是否存在
        const { data } = await supabase
          .from('seating_plans')
          .select('id')
          .eq('id', planId)
          .single();
          
        if (data) {
          state.planId = planId;
        } else {
          // 计划ID不存在，创建新计划
          state.planId = await createNewPlan();
        }
      } else {
        // 没有计划ID，创建新计划
        state.planId = await createNewPlan();
      }
      
      // 更新URL和显示
      updatePlanUrl();
      elements.planIdDisplay.textContent = state.planId.substring(0, 8) + '...';
    }
    
    // 创建新计划
    async function createNewPlan() {
      const { data, error } = await supabase
        .from('seating_plans')
        .insert([{ 
          name: '新座位计划',
          guests: [],
          tables: []
        }])
        .select();
      
      if (error) {
        showNotification('创建计划失败', 'error');
        console.error('Error creating plan:', error);
        return null;
      }
      
      return data[0].id;
    }
    
    // 更新URL中的计划ID
    function updatePlanUrl() {
      const url = new URL(window.location.href);
      url.searchParams.set('plan', state.planId);
      window.history.pushState({}, '', url);
    }
    
    // 加载数据
    async function loadData() {
      if (!state.planId) return;
      
      const { data, error } = await supabase
        .from('seating_plans')
        .select('guests, tables')
        .eq('id', state.planId)
        .single();
      
      if (error) {
        showNotification('加载数据失败', 'error');
        console.error('Error loading data:', error);
        return;
      }
      
      // 初始化数据
      state.guests = data.guests || [];
      state.tables = data.tables || [];
      
      // 渲染数据
      renderGuests();
      renderTables();
      updateCounters();
    }
    
    // 保存数据
    async function saveData() {
      if (!state.planId) return;
      
      const { error } = await supabase
        .from('seating_plans')
        .update({ 
          guests: state.guests,
          tables: state.tables,
          updated_at: new Date()
        })
        .eq('id', state.planId);
      
      if (error) {
        showNotification('保存失败', 'error');
        console.error('Error saving data:', error);
        return false;
      }
      
      showNotification('保存成功');
      return true;
    }
    
    // 渲染宾客列表
    function renderGuests() {
      elements.guestList.innerHTML = '';
      
      // 过滤宾客（这里简化处理，实际应根据搜索和筛选条件过滤）
      const filteredGuests = state.guests.filter(guest => !guest.tableId);
      
      if (filteredGuests.length === 0) {
        elements.emptyGuestState.classList.remove('hidden');
        return;
      }
      
      elements.emptyGuestState.classList.add('hidden');
      
      filteredGuests.forEach(guest => {
        const guestEl = document.createElement('div');
        guestEl.className = 'guest-item bg-gray-50 hover:bg-gray-100 p-2 rounded-md text-sm cursor-move transition-all border border-gray-200 hover:border-primary/30 flex justify-between items-center group';
        guestEl.setAttribute('data-id', guest.id);
        
        guestEl.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(guest.name)}</div>
            <div class="text-xs text-gray-500">${guest.peopleCount}人 · ${guest.category || '未分类'}</div>
          </div>
          <button class="delete-guest-btn text-gray-400 hover:text-danger opacity-0 group-hover:opacity-100 transition-opacity" data-id="${guest.id}">
            <i class="fa fa-times"></i>
          </button>
        `;
        
        elements.guestList.appendChild(guestEl);
        
        // 添加拖拽事件
        setupGuestDragEvents(guestEl, guest);
      });
      
      // 添加删除宾客事件
      document.querySelectorAll('.delete-guest-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const guestId = btn.getAttribute('data-id');
          deleteGuest(guestId);
        });
      });
    }
    
    // 设置宾客拖拽事件
    function setupGuestDragEvents(guestEl, guest) {
      guestEl.addEventListener('mousedown', (e) => {
        if (e.target.closest('.delete-guest-btn')) return;
        
        state.isDragging = true;
        state.draggedGuest = guest;
        guestEl.classList.add('opacity-50', 'scale-95');
        
        // 创建拖动时的视觉提示
        const ghostEl = guestEl.cloneNode(true);
        ghostEl.style.position = 'fixed';
        ghostEl.style.pointerEvents = 'none';
        ghostEl.style.zIndex = '100';
        ghostEl.style.opacity = '0.7';
        document.body.appendChild(ghostEl);
        
        // 鼠标移动时更新幽灵元素位置
        const handleMouseMove = (e) => {
          if (!state.isDragging) return;
          
          ghostEl.style.left = `${e.clientX - ghostEl.offsetWidth / 2}px`;
          ghostEl.style.top = `${e.clientY - ghostEl.offsetHeight / 2}px`;
        };
        
        // 鼠标释放时处理
        const handleMouseUp = (e) => {
          state.isDragging = false;
          guestEl.classList.remove('opacity-50', 'scale-95');
          document.body.removeChild(ghostEl);
          
          // 检查是否拖到了桌位上
          const tableEl = document.elementFromPoint(e.clientX, e.clientY).closest('.table-item:not(.placeholder-table)');
          if (tableEl && state.draggedGuest) {
            const tableId = tableEl.getAttribute('data-id');
            assignGuestToTable(state.draggedGuest.id, tableId);
          }
          
          // 移除事件监听
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
        
        // 添加事件监听
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });
    }
    
    // 渲染桌位
    function renderTables() {
      elements.tableArea.innerHTML = '';
      
      state.tables.forEach(table => {
        const tableEl = document.createElement('div');
        tableEl.className = `table-item absolute bg-white rounded-lg shadow-card hover:shadow-card-hover border-2 ${table.isPlaceholder ? 'border-dashed border-gray-400 bg-white/30' : 'border-gray-200 hover:border-primary'} transition-all duration-200 p-2 w-48`;
        tableEl.style.left = `${table.x}px`;
        tableEl.style.top = `${table.y}px`;
        tableEl.setAttribute('data-id', table.id);
        
        // 计算已入座人数
        const seatedCount = state.guests
          .filter(guest => guest.tableId === table.id)
          .reduce((sum, guest) => sum + guest.peopleCount, 0);
        
        // 检查是否超员
        const isOverCapacity = seatedCount > table.capacity && !table.isPlaceholder;
        
        // 桌位内容
        let tableContent = '';
        
        if (table.isPlaceholder) {
          // 占位桌
          tableContent = `
            <div class="text-center text-gray-500 text-sm font-medium">占位桌（不可用）</div>
          `;
        } else {
          // 正常桌位
          tableContent = `
            <div class="flex justify-between items-center mb-1">
              <div class="font-medium text-sm ${isOverCapacity ? 'text-danger' : ''}">${escapeHtml(table.name)}</div>
              <div class="text-xs ${isOverCapacity ? 'text-danger font-medium' : 'text-gray-500'}">
                ${seatedCount}/${table.capacity}人 ${isOverCapacity ? '(超员)' : ''}
              </div>
            </div>
            <div class="text-xs text-gray-600 max-h-32 overflow-y-auto scrollbar-hide">
          `;
          
          // 添加桌位上的宾客
          const tableGuests = state.guests.filter(guest => guest.tableId === table.id);
          tableGuests.forEach(guest => {
            tableContent += `
              <div class="flex justify-between items-center py-0.5 border-b border-gray-100">
                <span>${escapeHtml(guest.name)} (${guest.peopleCount}人)</span>
                <button class="remove-from-table-btn text-gray-400 hover:text-danger text-xs" data-guest-id="${guest.id}">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            `;
          });
          
          tableContent += `
            </div>
            <div class="mt-1 flex justify-end gap-1">
              <button class="table-edit-btn text-gray-400 hover:text-primary text-xs p-1" title="编辑" data-id="${table.id}">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="table-clear-btn text-gray-400 hover:text-gray-600 text-xs p-1" title="清空" data-id="${table.id}">
                <i class="fa fa-trash-o"></i>
              </button>
              <button class="table-delete-btn text-gray-400 hover:text-danger text-xs p-1" title="删除" data-id="${table.id}">
                <i class="fa fa-remove"></i>
              </button>
            </div>
          `;
        }
        
        tableEl.innerHTML = tableContent;
        elements.tableArea.appendChild(tableEl);
        
        // 如果不是占位桌，添加拖动功能
        if (!table.isPlaceholder) {
          setupTableDragEvents(tableEl, table);
        } else {
          // 占位桌双击恢复
          tableEl.addEventListener('dblclick', () => {
            restorePlaceholderTable(table.id);
          });
        }
      });
      
      // 添加桌位操作事件
      setupTableActionEvents();
    }
    
    // 设置桌位拖动事件
    function setupTableDragEvents(tableEl, table) {
      let initialX, initialY;
      let currentX = table.x;
      let currentY = table.y;
      let isDragging = false;
      
      tableEl.addEventListener('mousedown', (e) => {
        // 如果点击的是按钮，不触发拖动
        if (e.target.closest('button')) return;
        
        isDragging = true;
        tableEl.classList.add('scale-95', 'opacity-70');
        
        // 计算初始位置
        initialX = e.clientX - currentX;
        initialY = e.clientY - currentY;
        
        // 添加事件监听
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });
      
      function handleMouseMove(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        
        // 更新位置
        tableEl.style.left = `${currentX}px`;
        tableEl.style.top = `${currentY}px`;
      }
      
      function handleMouseUp() {
        if (!isDragging) return;
        
        isDragging = false;
        tableEl.classList.remove('scale-95', 'opacity-70');
        
        // 保存新位置
        updateTablePosition(table.id, currentX, currentY);
        
        // 移除事件监听
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      }
    }
    
    // 设置桌位操作事件
    function setupTableActionEvents() {
      // 编辑桌位
      document.querySelectorAll('.table-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tableId = btn.getAttribute('data-id');
          editTable(tableId);
        });
      });
      
      // 清空桌位
      document.querySelectorAll('.table-clear-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tableId = btn.getAttribute('data-id');
          clearTable(tableId);
        });
      });
      
      // 删除桌位
      document.querySelectorAll('.table-delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tableId = btn.getAttribute('data-id');
          showConfirmDialog(
            '删除桌位', 
            '确定要删除这个桌位吗？桌位上的宾客将被移回未入座列表。',
            () => deleteTable(tableId)
          );
        });
      });
      
      // 从桌位移除宾客
      document.querySelectorAll('.remove-from-table-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const guestId = btn.getAttribute('data-guest-id');
          removeGuestFromTable(guestId);
        });
      });
    }
    
    // 更新计数器
    function updateCounters() {
      // 宾客总数
      const totalGuestCount = state.guests.reduce((sum, guest) => sum + guest.peopleCount, 0);
      elements.guestCount.textContent = `${state.guests.length}人 (共${totalGuestCount}位)`;
      elements.totalPeople.textContent = totalGuestCount;
      
      // 桌位总数
      elements.totalTables.textContent = state.tables.filter(table => !table.isPlaceholder).length;
    }
    
    // 检查空状态
    function checkEmptyStates() {
      if (state.guests.filter(guest => !guest.tableId).length === 0) {
        elements.emptyGuestState.classList.remove('hidden');
      } else {
        elements.emptyGuestState.classList.add('hidden');
      }
    }
    
    // 添加宾客
    function addGuest(name, peopleCount = 1, category = '') {
      const newGuest = {
        id: Date.now().toString(),
        name,
        peopleCount: parseInt(peopleCount) || 1,
        category: category.trim() || '',
        tableId: null
      };
      
      state.guests.push(newGuest);
      renderGuests();
      updateCounters();
      saveData();
      showNotification(`已添加宾客: ${name}`);
    }
    
    // 批量添加宾客
    function batchAddGuests(text) {
      const lines = text.trim().split('\n');
      let addedCount = 0;
      
      lines.forEach(line => {
        if (!line.trim()) return;
        
        // 解析格式：姓名 [人数(可选)] (分类(可选))
        const regex = /^([^()\d]+?)\s*(\d+)?\s*(\(([^)]+)\))?$/;
        const match = line.match(regex);
        
        if (match) {
          const name = match[1].trim();
          const peopleCount = match[2] ? parseInt(match[2]) : 1;
          const category = match[4] || '';
          
          if (name) {
            addGuest(name, peopleCount, category);
            addedCount++;
          }
        } else {
          // 无法解析的格式，作为简单姓名处理
          const name = line.trim();
          if (name) {
            addGuest(name);
            addedCount++;
          }
        }
      });
      
      if (addedCount > 0) {
        showNotification(`已批量添加 ${addedCount} 位宾客`);
      }
    }
    
    // 删除宾客
    function deleteGuest(guestId) {
      const guestIndex = state.guests.findIndex(g => g.id === guestId);
      if (guestIndex === -1) return;
      
      const guestName = state.guests[guestIndex].name;
      state.guests.splice(guestIndex, 1);
      
      renderGuests();
      renderTables();
      updateCounters();
      saveData();
      showNotification(`已删除宾客: ${guestName}`);
    }
    
    // 添加桌位
    function addTable(name, capacity) {
      const tableArea = elements.tableArea;
      const newTable = {
        id: Date.now().toString(),
        name,
        capacity: parseInt(capacity) || 6,
        x: 50 + (state.tables.length % 5) * 200,
        y: 50 + Math.floor(state.tables.length / 5) * 150,
        isPlaceholder: false
      };
      
      state.tables.push(newTable);
      renderTables();
      updateCounters();
      saveData();
      showNotification(`已添加桌位: ${name}`);
      
      return newTable.id;
    }
    
    // 编辑桌位
    function editTable(tableId) {
      const table = state.tables.find(t => t.id === tableId);
      if (!table || table.isPlaceholder) return;
      
      // 填充表单
      document.getElementById('table-modal-title').textContent = '编辑桌位';
      document.getElementById('table-name').value = table.name;
      document.getElementById('table-capacity').value = table.capacity;
      
      // 保存当前桌位ID
      elements.tableModal.setAttribute('data-table-id', tableId);
      
      // 显示模态框
      elements.tableModal.classList.remove('hidden');
      elements.tableModal.classList.add('flex');
    }
    
    // 更新桌位位置
    function updateTablePosition(tableId, x, y) {
      const tableIndex = state.tables.findIndex(t => t.id === tableId);
      if (tableIndex === -1) return;
      
      state.tables[tableIndex].x = x;
      state.tables[tableIndex].y = y;
      saveData();
    }
    
    // 清空桌位
    function clearTable(tableId) {
      // 将桌位上的所有宾客移回未入座列表
      state.guests.forEach(guest => {
        if (guest.tableId === tableId) {
          guest.tableId = null;
        }
      });
      
      renderGuests();
      renderTables();
      saveData();
      
      const table = state.tables.find(t => t.id === tableId);
      if (table) {
        showNotification(`已清空桌位: ${table.name}`);
      }
    }
    
    // 删除桌位
    function deleteTable(tableId) {
      const tableIndex = state.tables.findIndex(t => t.id === tableId);
      if (tableIndex === -1) return;
      
      const tableName = state.tables[tableIndex].name;
      
      // 将桌位上的所有宾客移回未入座列表
      state.guests.forEach(guest => {
        if (guest.tableId === tableId) {
          guest.tableId = null;
        }
      });
      
      // 删除桌位
      state.tables.splice(tableIndex, 1);
      
      renderGuests();
      renderTables();
      updateCounters();
      saveData();
      showNotification(`已删除桌位: ${tableName}`);
    }
    
    // 将桌位转为占位桌
    function convertToPlaceholderTable(tableId) {
      const tableIndex = state.tables.findIndex(t => t.id === tableId);
      if (tableIndex === -1) return;
      
      // 将桌位上的所有宾客移回未入座列表
      state.guests.forEach(guest => {
        if (guest.tableId === tableId) {
          guest.tableId = null;
        }
      });
      
      // 标记为占位桌
      state.tables[tableIndex].isPlaceholder = true;
      
      renderGuests();
      renderTables();
      saveData();
    }
    
    // 恢复占位桌为正常桌位
    function restorePlaceholderTable(tableId) {
      const tableIndex = state.tables.findIndex(t => t.id === tableId);
      if (tableIndex === -1) return;
      
      // 恢复为正常桌位
      state.tables[tableIndex].isPlaceholder = false;
      
      renderTables();
      saveData();
      showNotification('已恢复为可用桌位');
    }
    
    // 将宾客分配到桌位
    function assignGuestToTable(guestId, tableId) {
      const guest = state.guests.find(g => g.id === guestId);
      const table = state.tables.find(t => t.id === tableId && !t.isPlaceholder);
      
      if (!guest || !table) return;
      
      // 检查是否会超员
      const currentSeated = state.guests
        .filter(g => g.tableId === tableId)
        .reduce((sum, g) => sum + g.peopleCount, 0);
      
      const wouldExceed = currentSeated + guest.peopleCount > table.capacity;
      
      // 如果会超员，显示警告但仍允许分配
      if (wouldExceed) {
        showNotification(`桌位 "${table.name}" 将超员`, 'warning');
      }
      
      // 分配宾客
      guest.tableId = tableId;
      
      renderGuests();
      renderTables();
      saveData();
    }
    
    // 将宾客从桌位移除
    function removeGuestFromTable(guestId) {
      const guest = state.guests.find(g => g.id === guestId);
      if (!guest) return;
      
      const table = state.tables.find(t => t.id === guest.tableId);
      const tableName = table ? table.name : '';
      
      guest.tableId = null;
      
      renderGuests();
      renderTables();
      saveData();
      
      if (tableName) {
        showNotification(`${guest.name} 已从 ${tableName} 移走`);
      }
    }
    
    // 自动排座
    function autoArrangeSeats(groupByCategory = false, optimizeUtilization = false) {
      // 获取所有未入座宾客
      const unassignedGuests = [...state.guests.filter(g => !g.tableId)];
      if (unassignedGuests.length === 0) {
        showNotification('没有需要排座的宾客');
        return;
      }
      
      // 获取所有可用桌位
      const availableTables = state.tables
        .filter(t => !t.isPlaceholder)
        .map(t => ({
          ...t,
          currentCount: state.guests
            .filter(g => g.tableId === t.id)
            .reduce((sum, g) => sum + g.peopleCount, 0)
        }));
      
      if (availableTables.length === 0) {
        showNotification('没有可用的桌位', 'warning');
        return;
      }
      
      // 如果需要按类别分组
      if (groupByCategory) {
        // 按类别分组
        const guestsByCategory = {};
        unassignedGuests.forEach(guest => {
          const category = guest.category || '未分类';
          if (!guestsByCategory[category]) {
            guestsByCategory[category] = [];
          }
          guestsByCategory[category].push(guest);
        });
        
        // 为每个类别分配桌位
        Object.values(guestsByCategory).forEach(categoryGuests => {
          assignGuestsToTables(categoryGuests, [...availableTables], optimizeUtilization);
        });
      } else {
        // 不分组，直接分配
        assignGuestsToTables(unassignedGuests, [...availableTables], optimizeUtilization);
      }
      
      renderGuests();
      renderTables();
      saveData();
      showNotification('自动排座完成');
    }
    
    // 将宾客分配到桌位的辅助函数
    function assignGuestsToTables(guests, tables, optimizeUtilization) {
      // 如果需要优化利用率，按剩余容量排序（从小到大）
      if (optimizeUtilization) {
        tables.sort((a, b) => {
          const remainingA = a.capacity - a.currentCount;
          const remainingB = b.capacity - b.currentCount;
          return remainingA - remainingB;
        });
      }
      
      // 为每位宾客分配桌位
      guests.forEach(guest => {
        // 找到第一个能容纳的桌位
        for (const table of tables) {
          const remainingCapacity = table.capacity - table.currentCount;
          if (remainingCapacity >= guest.peopleCount) {
            // 分配到这个桌位
            guest.tableId = table.id;
            table.currentCount += guest.peopleCount;
            break;
          }
        }
        
        // 如果没有找到能完全容纳的桌位，就找第一个可用桌位（允许超员）
        if (!guest.tableId) {
          const firstAvailableTable = tables.find(t => !t.isPlaceholder);
          if (firstAvailableTable) {
            guest.tableId = firstAvailableTable.id;
            firstAvailableTable.currentCount += guest.peopleCount;
          }
        }
      });
    }
    
    // 重置所有数据
    function resetAllData() {
      // 恢复默认示例数据
      state.guests = [
        { id: '1', name: '张三', peopleCount: 2, category: '家人', tableId: null },
        { id: '2', name: '李四', peopleCount: 1, category: '朋友', tableId: null },
        { id: '3', name: '王五', peopleCount: 3, category: '同事', tableId: null },
        { id: '4', name: '赵六', peopleCount: 2, category: '家人', tableId: null },
        { id: '5', name: '钱七', peopleCount: 1, category: '朋友', tableId: null },
      ];
      
      state.tables = [
        { id: '101', name: '主桌', capacity: 8, x: 50, y: 50, isPlaceholder: false },
        { id: '102', name: '1号桌', capacity: 6, x: 250, y: 50, isPlaceholder: false },
        { id: '103', name: '2号桌', capacity: 6, x: 450, y: 50, isPlaceholder: false },
        { id: '104', name: '3号桌', capacity: 4, x: 50, y: 200, isPlaceholder: false },
        { id: '105', name: '4号桌', capacity: 4, x: 250, y: 200, isPlaceholder: false },
      ];
      
      renderGuests();
      renderTables();
      updateCounters();
      saveData();
      showNotification('已重置为示例数据');
    }
    
    // 导出数据
    function exportData(format = 'json') {
      const exportData = {
        planId: state.planId,
        guests: state.guests,
        tables: state.tables,
        exportTime: new Date().toISOString()
      };
      
      let dataStr, fileName;
      
      if (format === 'json') {
        dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
        fileName = `座位计划_${state.planId.substring(0, 8)}_${new Date().toLocaleDateString()}.json`;
      } else if (format === 'csv') {
        // 生成CSV格式
        let csvContent = "姓名,人数,分类,桌位\n";
        
        // 已入座宾客
        state.guests.forEach(guest => {
          const table = state.tables.find(t => t.id === guest.tableId);
          const tableName = table ? table.name : '';
          csvContent += `${escapeCsv(guest.name)},${guest.peopleCount},${escapeCsv(guest.category || '')},${escapeCsv(tableName)}\n`;
        });
        
        dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
        fileName = `座位计划_${state.planId.substring(0, 8)}_${new Date().toLocaleDateString()}.csv`;
      }
      
      // 创建下载链接
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", fileName);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      showNotification(`已导出${format.toUpperCase()}文件`);
    }
    
    // 打印功能
    function printPlan() {
      // 打开新窗口用于打印
      const printWindow = window.open('', '_blank');
      
      // 构建打印内容
      printWindow.document.write(`
        <html>
          <head>
            <title>座位计划打印</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { text-align: center; color: #333; }
              .table { border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin: 15px; display: inline-block; vertical-align: top; min-width: 180px; }
              .table h3 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
              .guest { font-size: 14px; margin-bottom: 5px; }
              .placeholder { background-color: #f5f5f5; border-style: dashed; }
              .summary { margin: 20px 0; padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
            </style>
          </head>
          <body>
            <h1>座位计划</h1>
            <div class="summary">
              <p>计划ID: ${state.planId.substring(0, 8)}...</p>
              <p>总桌位: ${state.tables.filter(t => !t.isPlaceholder).length} 个 | 总人数: ${state.guests.reduce((sum, g) => sum + g.peopleCount, 0)} 人</p>
              <p>打印时间: ${new Date().toLocaleString()}</p>
            </div>
            <div id="print-tables">
              ${generatePrintTablesHtml()}
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // 等待窗口加载完成后打印
      printWindow.onload = function() {
        printWindow.print();
        // 打印后关闭窗口
        setTimeout(() => printWindow.close(), 100);
      };
    }
    
    // 生成打印用的桌位HTML
    function generatePrintTablesHtml() {
      let html = '';
      
      state.tables.forEach(table => {
        if (table.isPlaceholder) return; // 跳过占位桌
        
        // 计算已入座人数
        const seatedCount = state.guests
          .filter(guest => guest.tableId === table.id)
          .reduce((sum, guest) => sum + guest.peopleCount, 0);
        
        // 桌位内容
        html += `<div class="table">`;
        html += `<h3>${table.name} (${seatedCount}/${table.capacity}人)</h3>`;
        
        // 添加桌位上的宾客
        const tableGuests = state.guests.filter(guest => guest.tableId === table.id);
        if (tableGuests.length > 0) {
          tableGuests.forEach(guest => {
            html += `<div class="guest">${guest.name} (${guest.peopleCount}人) ${guest.category ? `[${guest.category}]` : ''}</div>`;
          });
        } else {
          html += `<div class="guest">空桌</div>`;
        }
        
        html += `</div>`;
      });
      
      return html;
    }
    
    // 设置协作功能
    function setupCollaboration() {
      if (!state.planId) return;
      
      // 监听数据变化
      const subscription = supabase
        .channel(`seating_plan:${state.planId}`)
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'seating_plans', filter: `id=eq.${state.planId}` },
          (payload) => {
            // 数据变化时重新加载
            if (payload.eventType === 'UPDATE') {
              loadData();
            }
          }
        )
        .subscribe();
      
      // 在线状态管理（简化版）
      const presence = supabase
        .channel(`presence:${state.planId}`)
        .on('presence', { event: 'sync' }, () => {
          const presences = presence.presenceState();
          const users = Object.values(presences).flat();
          state.onlineUsers = users.length;
          elements.onlineCount.textContent = state.onlineUsers;
        })
        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            // 追踪当前用户
            await presence.track({
              id: Date.now().toString(),
              online: true,
              updated_at: new Date().toISOString()
            });
          }
        });
    }
    
    // 显示通知
    function showNotification(message, type = 'success') {
      elements.notificationMessage.textContent = message;
      
      // 设置图标
      if (type === 'success') {
        elements.notificationIcon.className = 'fa fa-check-circle text-green-400 mr-2';
      } else if (type === 'error') {
        elements.notificationIcon.className = 'fa fa-times-circle text-red-400 mr-2';
      } else if (type === 'warning') {
        elements.notificationIcon.className = 'fa fa-exclamation-triangle text-yellow-400 mr-2';
      }
      
      // 显示通知
      elements.notification.classList.remove('translate-y-20', 'opacity-0');
      elements.notification.classList.add('translate-y-0', 'opacity-100');
      
      // 3秒后隐藏
      setTimeout(() => {
        elements.notification.classList.remove('translate-y-0', 'opacity-100');
        elements.notification.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }
    
    // 显示确认对话框
    function showConfirmDialog(title, message, onConfirm) {
      elements.confirmDialog.setAttribute('data-callback', onConfirm.name);
      elements.confirmTitle.textContent = title;
      elements.confirmMessage.textContent = message;
      
      // 保存回调函数
      window.confirmCallback = onConfirm;
      
      // 显示对话框
      elements.confirmDialog.classList.remove('hidden');
      elements.confirmDialog.classList.add('flex');
    }
    
    // 设置事件监听器
    function setupEventListeners() {
      // 添加宾客
      document.getElementById('add-guest-btn').addEventListener('click', () => {
        const guestText = document.getElementById('new-guest').value.trim();
        if (guestText) {
          batchAddGuests(guestText);
          document.getElementById('new-guest').value = '';
        }
      });
      
      // 按回车添加宾客
      document.getElementById('new-guest').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('add-guest-btn').click();
        }
      });
      
      // 批量添加宾客
      document.getElementById('batch-add-btn').addEventListener('click', () => {
        elements.batchAddModal.classList.remove('hidden');
        elements.batchAddModal.classList.add('flex');
        document.getElementById('batch-guests').focus();
      });
      
      // 关闭批量添加模态框
      document.getElementById('close-batch-modal').addEventListener('click', () => {
        elements.batchAddModal.classList.remove('flex');
        elements.batchAddModal.classList.add('hidden');
      });
      
      // 确认批量添加
      document.getElementById('confirm-batch-add').addEventListener('click', () => {
        const batchText = document.getElementById('batch-guests').value;
        if (batchText.trim()) {
          batchAddGuests(batchText);
          document.getElementById('batch-guests').value = '';
        }
        elements.batchAddModal.classList.remove('flex');
        elements.batchAddModal.classList.add('hidden');
      });
      
      // 添加桌位
      document.getElementById('add-table-btn').addEventListener('click', () => {
        document.getElementById('table-modal-title').textContent = '添加桌位';
        document.getElementById('table-name').value = '';
        document.getElementById('table-capacity').value = '6';
        elements.tableModal.removeAttribute('data-table-id');
        
        elements.tableModal.classList.remove('hidden');
        elements.tableModal.classList.add('flex');
        document.getElementById('table-name').focus();
      });
      
      // 关闭桌位模态框
      document.getElementById('close-table-modal').addEventListener('click', () => {
        elements.tableModal.classList.remove('flex');
        elements.tableModal.classList.add('hidden');
      });
      
      // 确认添加/编辑桌位
      document.getElementById('confirm-table').addEventListener('click', () => {
        const tableName = document.getElementById('table-name').value.trim();
        const tableCapacity = document.getElementById('table-capacity').value.trim();
        
        if (!tableName || !tableCapacity || isNaN(tableCapacity) || parseInt(tableCapacity) < 1) {
          showNotification('请输入有效的桌位名称和容量', 'warning');
          return;
        }
        
        const tableId = elements.tableModal.getAttribute('data-table-id');
        
        if (tableId) {
          // 编辑现有桌位
          const tableIndex = state.tables.findIndex(t => t.id === tableId);
          if (tableIndex !== -1) {
            const oldName = state.tables[tableIndex].name;
            state.tables[tableIndex].name = tableName;
            state.tables[tableIndex].capacity = parseInt(tableCapacity);
            
            renderTables();
            saveData();
            showNotification(`已更新桌位: ${oldName} → ${tableName}`);
          }
        } else {
          // 添加新桌位
          addTable(tableName, tableCapacity);
        }
        
        elements.tableModal.classList.remove('flex');
        elements.tableModal.classList.add('hidden');
      });
      
      // 自动排座
      document.getElementById('auto-arrange-btn').addEventListener('click', () => {
        elements.arrangeModal.classList.remove('hidden');
        elements.arrangeModal.classList.add('flex');
      });
      
      // 关闭自动排座模态框
      document.getElementById('close-arrange-modal').addEventListener('click', () => {
        elements.arrangeModal.classList.remove('flex');
        elements.arrangeModal.classList.add('hidden');
      });
      
      // 确认自动排座
      document.getElementById('confirm-arrange').addEventListener('click', () => {
        const groupByCategory = document.getElementById('group-by-category').checked;
        const optimizeUtilization = document.getElementById('optimize-utilization').checked;
        
        autoArrangeSeats(groupByCategory, optimizeUtilization);
        
        elements.arrangeModal.classList.remove('flex');
        elements.arrangeModal.classList.add('hidden');
      });
      
      // 分享链接
      document.getElementById('share-btn').addEventListener('click', () => {
        const shareLink = window.location.href;
        document.getElementById('share-link').value = shareLink;
        
        elements.shareModal.classList.remove('hidden');
        elements.shareModal.classList.add('flex');
      });
      
      // 关闭分享模态框
      document.getElementById('close-share-modal').addEventListener('click', () => {
        elements.shareModal.classList.remove('flex');
        elements.shareModal.classList.add('hidden');
      });
      
      // 复制分享链接
      document.getElementById('copy-link-btn').addEventListener('click', () => {
        const shareLink = document.getElementById('share-link');
        shareLink.select();
        document.execCommand('copy');
        
        showNotification('链接已复制到剪贴板');
        elements.shareModal.classList.remove('flex');
        elements.shareModal.classList.add('hidden');
      });
      
      // 移动端菜单
      document.getElementById('mobile-menu-btn').addEventListener('click', () => {
        elements.mobileMenu.classList.remove('hidden');
      });
      
      // 关闭移动端菜单
      document.getElementById('close-mobile-menu').addEventListener('click', () => {
        elements.mobileMenu.classList.add('hidden');
      });
      
      // 点击移动端菜单外部关闭
      elements.mobileMenu.addEventListener('click', (e) => {
        if (e.target === elements.mobileMenu) {
          elements.mobileMenu.classList.add('hidden');
        }
      });
      
      // 清空未入座宾客
      document.getElementById('clear-unassigned-btn').addEventListener('click', () => {
        const unassignedCount = state.guests.filter(g => !g.tableId).length;
        if (unassignedCount === 0) {
          showNotification('没有未入座的宾客');
          return;
        }
        
        showConfirmDialog(
          '清空未入座宾客',
          `确定要删除所有未入座的宾客吗？（共${unassignedCount}位）`,
          () => {
            state.guests = state.guests.filter(g => g.tableId !== null);
            renderGuests();
            updateCounters();
            saveData();
            showNotification(`已删除 ${unassignedCount} 位未入座宾客`);
          }
        );
      });
      
      // 重置全部
      document.getElementById('reset-all-btn').addEventListener('click', () => {
        showConfirmDialog(
          '重置全部数据',
          '确定要重置所有数据吗？当前的座位计划将被替换为示例数据。',
          resetAllData
        );
      });
      
      // 保存
      document.getElementById('save-btn').addEventListener('click', saveData);
      
      // 导出
      document.getElementById('export-btn').addEventListener('click', () => {
        // 简单实现，实际可显示格式选择
        exportData('json');
      });
      
      // 打印
      document.getElementById('print-btn').addEventListener('click', printPlan);
      
      // 关闭确认对话框
      document.getElementById('cancel-confirm').addEventListener('click', () => {
        elements.confirmDialog.classList.remove('flex');
        elements.confirmDialog.classList.add('hidden');
        window.confirmCallback = null;
      });
      
      // 确认操作
      document.getElementById('accept-confirm').addEventListener('click', () => {
        if (window.confirmCallback && typeof window.confirmCallback === 'function') {
          window.confirmCallback();
        }
        
        elements.confirmDialog.classList.remove('flex');
        elements.confirmDialog.classList.add('hidden');
        window.confirmCallback = null;
      });
      
      // 缩放控制
      document.getElementById('zoom-in-btn').addEventListener('click', () => {
        if (state.zoomLevel < 200) {
          state.zoomLevel += 10;
          updateZoom();
        }
      });
      
      document.getElementById('zoom-out-btn').addEventListener('click', () => {
        if (state.zoomLevel > 50) {
          state.zoomLevel -= 10;
          updateZoom();
        }
      });
      
      document.getElementById('zoom-reset-btn').addEventListener('click', () => {
        state.zoomLevel = 100;
        updateZoom();
      });
      
      // 分类筛选
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // 移除所有按钮的活跃状态
          document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('active', 'bg-primary', 'text-white');
            b.classList.add('bg-gray-100', 'text-gray-700');
          });
          
          // 设置当前按钮为活跃状态
          btn.classList.add('active', 'bg-primary', 'text-white');
          btn.classList.remove('bg-gray-100', 'text-gray-700');
          
          // 实际筛选逻辑在这里实现
          const category = btn.textContent.trim();
          // 简化处理，实际应根据分类筛选宾客
          renderGuests();
        });
      });
      
      // 搜索宾客
      document.getElementById('guest-search').addEventListener('input', () => {
        // 实际搜索逻辑在这里实现
        renderGuests();
      });
    }
    
    // 更新缩放级别
    function updateZoom() {
      elements.tableArea.style.transform = `scale(${state.zoomLevel / 100})`;
      elements.tableArea.style.transformOrigin = 'top left';
      document.getElementById('zoom-reset-btn').textContent = `${state.zoomLevel}%`;
    }
    
    // 工具函数：转义HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 工具函数：转义CSV内容
    function escapeCsv(text) {
      if (!text) return '';
      if (text.includes(',') || text.includes('"') || text.includes('\n')) {
        return `"${text.replace(/"/g, '""')}"`;
      }
      return text;
    }
    
    // 初始化应用
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
