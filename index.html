<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å®¾å®¢åº§ä½è§„åˆ’ï¼ˆæ”¯æŒäººæ•° | å®æ—¶åä½œï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ 
    --bg:#0f1220; 
    --panel:#171b2c; 
    --accent:#6aa7ff; 
    --accent-2:#9f7bff; 
    --text:#e7ecff; 
    --muted:#9aa4c7; 
    --card:#1c2140; 
    --chip:#242a52; 
    --border:rgba(255,255,255,.08); 
    --cols:3; 
    --success:#4cd964;
    --warning:#ffcc00;
    --error:#ff3b30;
  }
  *{box-sizing:border-box} 
  html,body{height:100%}
  body{ 
    margin:0; 
    background: radial-gradient(1200px 600px at 20% -10%, #1a2040 0, #0f1220 70%), var(--bg); 
    color:var(--text); 
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif; 
    display:flex; 
    gap:12px; 
    padding:12px; 
    overflow:hidden; 
  }
  .sidebar{ 
    width:320px; 
    min-width:260px; 
    max-width:380px; 
    background:var(--panel); 
    border:1px solid var(--border); 
    border-radius:16px; 
    padding:14px; 
    display:flex; 
    flex-direction:column; 
    gap:14px; 
    overflow:hidden;
  }
  
  /* åŠŸèƒ½å¡ç‰‡æ ·å¼ */
  .sidebar-section {
    background: var(--card);
    border-radius: 12px;
    padding: 12px;
    border: 1px solid var(--border);
  }
  
  h1{font-size:16px; margin:0 0 8px 0; letter-spacing:.5px; display:flex; align-items:center; gap:6px}
  h1 i {color: var(--accent);}
  
  .controls,.stats{display:grid; gap:8px}
  .controls input[type="text"], 
  .controls input[type="number"], 
  textarea, 
  input[type="file"]{ 
    width:100%; 
    padding:10px 12px; 
    border-radius:10px; 
    border:1px solid var(--border); 
    background:#0f1330; 
    color:var(--text); 
    outline:none; 
    transition:border-color 0.2s;
  }
  .controls input:focus, textarea:focus {
    border-color: var(--accent);
  }
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .btn{ 
    appearance:none; 
    border:none; 
    cursor:pointer; 
    padding:10px 12px; 
    border-radius:10px; 
    color:white; 
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); 
    box-shadow:0 6px 20px rgba(106,167,255,.25); 
    transition:.15s transform ease,.15s filter ease,.15s opacity ease; 
    white-space:nowrap; 
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
  }
  .btn:hover{filter:brightness(1.05)} 
  .btn:active{transform:translateY(1px)} 
  .btn.ghost{background:transparent; border:1px solid var(--border); color:var(--text); box-shadow:none}
  .btn.warn{background:linear-gradient(135deg,#ff8a8a,#ff6b6b)}
  
  /* æ”¹è¿›çš„å®¾å®¢åˆ—è¡¨æ ·å¼ */
  .guest-list-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
  }
  .guest-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px;
    border: 1px dashed var(--border);
    border-radius: 12px;
    background:rgba(0,0,0,.12);
    /* ç¡®ä¿æ»šåŠ¨æ¡ç¾è§‚ */
    scrollbar-width: thin;
    scrollbar-color: var(--accent) transparent;
  }
  .guest-list::-webkit-scrollbar {
    width: 6px;
  }
  .guest-list::-webkit-scrollbar-track {
    background: transparent;
  }
  .guest-list::-webkit-scrollbar-thumb {
    background-color: var(--accent);
    border-radius: 3px;
  }
  
  .guest{
    user-select:none; 
    display:flex; 
    align-items:center; 
    gap:8px; 
    padding:8px 10px; 
    border-radius:10px; 
    background:var(--chip); 
    border:1px solid var(--border);
    transition:all 0.2s;
  }
  .guest:hover {
    border-color: rgba(255,255,255,0.2);
  }
  .guest.dragging{opacity:.6; transform:scale(0.98)} 
  .guest .tag{font-size:12px; color:var(--muted); margin-left:auto}
  .guest .count {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    margin-right: 4px;
  }
  .guest .category {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    margin-right: 4px;
  }
  .search{ 
    padding:8px 10px; 
    border-radius:10px; 
    border:1px solid var(--border); 
    background:#0f1330; 
    color:var(--text);
    transition:border-color 0.2s;
    width: 100%;
  }
  .search:focus {
    border-color: var(--accent);
  }
  .main{flex:1; min-width:0; display:flex; flex-direction:column; gap:10px}
  .toolbar{ 
    background:var(--panel); 
    border:1px solid var(--border); 
    border-radius:16px; 
    padding:10px; 
    display:flex; 
    gap:8px; 
    flex-wrap:wrap; 
    align-items:center 
  }
  .stats{ 
    display:flex; 
    align-items:center; 
    gap:10px; 
    flex-wrap:wrap; 
    margin-left:auto 
  }
  .pill{ 
    padding:8px 10px; 
    border-radius:999px; 
    background:var(--chip); 
    border:1px solid var(--border); 
    color:var(--text) 
  }
  .canvas{ 
    flex:1; 
    overflow:auto; 
    padding:12px; 
    display:grid; 
    grid-template-columns: repeat(var(--cols), minmax(260px,1fr)); 
    gap:12px 
  }
  .table-card{ 
    background:var(--card); 
    border:1px solid var(--border); 
    border-radius:16px; 
    padding:12px; 
    display:flex; 
    flex-direction:column; 
    gap:10px;
    transition:all 0.2s;
  }
  .table-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .table-header{ display:flex; align-items:center; gap:10px }
  .badge{ 
    font-weight:600; 
    padding:6px 10px; 
    border-radius:999px; 
    background:linear-gradient(135deg,#27305d,#1f2550); 
    border:1px solid var(--border) 
  }
  .capacity{ margin-left:auto; font-size:12px; color:var(--muted) }
  .table-visual{ display:flex; align-items:center; justify-content:center; padding:10px 0 6px }
  .round-wrap{ position:relative; width:220px; height:220px; margin:auto }
  .round{ 
    position:absolute; 
    left:50%; 
    top:50%; 
    transform:translate(-50%,-50%); 
    width:120px; 
    height:120px; 
    border-radius:50%; 
    background:#2a2f68; 
    border:2px solid var(--border); 
    box-shadow: inset 0 0 0 4px rgba(255,255,255,.05); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    color:#cfe3ff; 
    font-weight:600 
  }
  .chair{ 
    position:absolute; 
    width:64px; 
    height:28px; 
    border-radius:14px; 
    background:#222861; 
    border:1px solid var(--border); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    padding:0 6px; 
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis;
    transition:all 0.2s;
  }
  .chair:hover {
    transform: scale(1.05);
    z-index: 10;
  }
  .chair.empty{ opacity:.45; font-size:12px; color:var(--muted) }
  .chair.conflict {
    background: rgba(255, 59, 48, 0.3);
    border-color: var(--error);
  }
  .chair .count {
    font-size: 10px;
    margin-left: 4px;
    color: rgba(255, 255, 255, 0.7);
  }
  .chair .kick{ 
    margin-left:6px; 
    text-decoration:underline; 
    cursor:pointer; 
    color:#f8b4b4; 
    font-size:12px;
    opacity:0.7;
    transition:opacity 0.2s;
  }
  .chair:hover .kick {
    opacity:1;
  }
  .table-footer{ display:flex; align-items:center; gap:6px; color:var(--muted) }
  .spacer{flex:1} 
  .link{
    color:var(--accent); 
    cursor:pointer; 
    text-decoration:underline; 
    font-size:12px;
    transition:color 0.2s;
  }
  .link:hover {
    color: var(--accent-2);
  }
  .grid-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap } 
  .grid-controls input[type="range"]{ width:160px }
  
  /* æç¤ºæ¶ˆæ¯æ ·å¼ */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .toast {
    padding: 12px 16px;
    border-radius: 8px;
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 8px;
    animation: toastIn 0.3s ease forwards, toastOut 0.3s ease 2.7s forwards;
    max-width: 300px;
  }
  .toast.success { background-color: var(--success); }
  .toast.error { background-color: var(--error); }
  .toast.warning { background-color: var(--warning); color: #333; }
  
  @keyframes toastIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes toastOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  /* å®¾å®¢åˆ†ç±»é€‰æ‹©å™¨ */
  .category-selector {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }
  .category-btn {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    background: var(--chip);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
  }
  .category-btn:hover {
    background: rgba(255,255,255,0.15);
  }
  .category-btn.active {
    background: var(--accent);
    color: white;
  }
  
  /* æ‰¹é‡æ“ä½œèœå• */
  .batch-actions {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed var(--border);
  }
  
  /* æ‰“å°æ ·å¼ä¼˜åŒ– */
  @media print {
    body {
      background: white;
      color: black;
      display: block;
      padding: 20px;
      overflow: visible;
    }
    .sidebar, .toolbar {
      display: none !important;
    }
    .main {
      width: 100%;
      display: block;
    }
    .canvas {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 0;
    }
    .table-card {
      background: white;
      border: 1px solid #ccc;
      color: black;
      page-break-inside: avoid;
    }
    .round {
      background: #f0f0f0;
      border-color: #ccc;
      color: black;
    }
    .chair {
      background: #f0f0f0;
      border-color: #ccc;
      color: black;
    }
    .chair.empty {
      display: none;
    }
    .table-footer {
      display: none;
    }
  }
  
  @media (max-width:920px){ 
    body{
      flex-direction:column; 
      overflow:auto; 
      padding:10px
    } 
    .sidebar{
      width:auto; 
      max-width:none;
      height: auto;
      max-height: 80vh;
    } 
    .canvas{
      grid-template-columns:repeat(1, minmax(260px,1fr))
    } 
  }
</style>
</head>
<body>
  <!-- æç¤ºæ¶ˆæ¯å®¹å™¨ -->
  <div class="toast-container" id="toastContainer"></div>

  <aside class="sidebar">
    <!-- å®¾å®¢ç®¡ç†åŒºåŸŸ -->
    <div class="sidebar-section">
      <h1><i class="fas fa-users"></i> å®¾å®¢ç®¡ç†</h1>
      <input id="search" class="search" type="text" placeholder="æœç´¢å§“åâ€¦" />
      
      <!-- å®¾å®¢åˆ†ç±»ç­›é€‰ -->
      <div class="category-selector" id="categoryFilter">
        <div class="category-btn active" data-category="all">å…¨éƒ¨</div>
        <div class="category-btn" data-category="family">å®¶äºº</div>
        <div class="category-btn" data-category="friend">æœ‹å‹</div>
        <div class="category-btn" data-category="colleague">åŒäº‹</div>
        <div class="category-btn" data-category="other">å…¶ä»–</div>
      </div>
      
      <textarea id="bulkNames" rows="4" placeholder="æ‰¹é‡ç²˜è´´å§“åï¼šæ¯è¡Œä¸€ä¸ªï¼›å¯å¸¦äººæ•°ï¼Œå¦‚â€œå¼ ä¸‰ 2â€è¡¨ç¤ºå¼ ä¸‰ä¸€è¡Œå…±2äººï¼›å¯å¸¦å¤‡æ³¨ï¼Œå¦‚â€œæå›› 4ï¼ˆåŒäº‹ï¼‰â€"></textarea>
      
      <!-- å®¾å®¢åˆ†ç±»é€‰æ‹© -->
      <div>
        <label style="font-size:12px; color:var(--muted); margin-bottom:4px; display:block;">æ·»åŠ ä¸ºï¼š</label>
        <select id="guestCategory" style="width:100%; padding:8px; border-radius:8px; background:#0f1330; border:1px solid var(--border); color:var(--text);">
          <option value="family">å®¶äºº</option>
          <option value="friend">æœ‹å‹</option>
          <option value="colleague">åŒäº‹</option>
          <option value="other">å…¶ä»–</option>
        </select>
      </div>
      
      <div class="row">
        <button class="btn" id="addGuestsBtn">
          <i class="fas fa-user-plus"></i> æ·»åŠ åˆ°åå•
        </button>
        <button class="btn ghost" id="clearGuestsBtn" title="ä»…æ¸…ç©ºæœªå…¥åº§åˆ—è¡¨ï¼Œä¸å½±å“æ¡Œä¸Šå·²å…¥åº§">
          <i class="fas fa-trash"></i> æ¸…ç©º
        </button>
      </div>
    </div>
    
    <!-- æ¡Œä½ç®¡ç†åŒºåŸŸ -->
    <div class="sidebar-section">
      <h1><i class="fas fa-utensils"></i> æ¡Œä½ç®¡ç†</h1>
      <div class="row">
        <input id="tableName" type="text" placeholder="æ¡Œåï¼ˆå¦‚ï¼š1å·æ¡Œï¼‰">
        <input id="tableCap" type="number" min="1" value="10" title="åº§ä½æ•°">
        <button class="btn" id="addTableBtn">
          <i class="fas fa-plus-square"></i> æ–°å¢
        </button>
      </div>
      
      <div class="row">
        <button class="btn" id="autoSeatBtn" title="æŒ‰æ¡Œå®¹é‡ä»ä¸Šåˆ°ä¸‹è‡ªåŠ¨æ’åº§">
          <i class="fas fa-magic"></i> è‡ªåŠ¨æ’åº§
        </button>
        <button class="btn ghost" id="shuffleBtn" title="éšæœºæ‰“æ•£æœªå…¥åº§åå•">
          <i class="fas fa-random"></i> æ‰“æ•£
        </button>
      </div>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
    <div class="sidebar-section">
      <h1><i class="fas fa-layer-group"></i> æ‰¹é‡æ“ä½œ</h1>
      <div class="row">
        <select id="batchTableSelect" style="flex:1; padding:8px; border-radius:8px; background:#0f1330; border:1px solid var(--border); color:var(--text);">
          <option value="">é€‰æ‹©ç›®æ ‡æ¡Œ...</option>
        </select>
        <button class="btn ghost" id="batchMoveBtn" title="å°†æ‰€æœ‰æœªå…¥åº§å®¾å®¢ç§»åŠ¨åˆ°æ‰€é€‰æ¡Œ">
          <i class="fas fa-arrow-right"></i> ç§»åŠ¨å…¨éƒ¨
        </button>
      </div>
    </div>
    
    <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
    <div class="sidebar-section">
      <h1><i class="fas fa-database"></i> æ•°æ®ç®¡ç†</h1>
      <div class="row">
        <button class="btn ghost" id="exportBtn">
          <i class="fas fa-download"></i> å¯¼å‡ºJSON
        </button>
        <input id="importFile" type="file" accept=".json">
        <button class="btn ghost" id="printBtn">
          <i class="fas fa-print"></i> æ‰“å°
        </button>
      </div>
      
      <div class="row">
        <button class="btn warn" id="resetAllBtn">
          <i class="fas fa-exclamation-triangle"></i> é‡ç½®å…¨éƒ¨
        </button>
      </div>
    </div>

    <!-- æœªå…¥åº§å®¾å®¢åˆ—è¡¨åŒºåŸŸ - å æ®å‰©ä½™ç©ºé—´ -->
    <div class="sidebar-section guest-list-container">
      <h1><i class="fas fa-list"></i> æœªå…¥åº§å®¾å®¢</h1>
      <div id="guestList" class="guest-list" aria-label="æœªå…¥åº§åˆ—è¡¨"></div>
    </div>
  </aside>

  <main class="main">
    <div class="toolbar">
      <div class="pill">å®æ—¶åä½œï¼šæŠŠä¸‹é¢çš„åˆ†äº«é“¾æ¥å‘ç»™åŒäº‹/äº²å‹ï¼Œå¤§å®¶çœ‹åˆ°çš„æ˜¯åŒä¸€ä»½åº§ä½è¡¨ã€‚</div>
      <div class="stats" id="stats"></div>
    </div>

    <div class="toolbar" style="gap:10px">
      <div class="grid-controls">
        <span>æ¯æ’æ¡Œæ•°ï¼š</span>
        <input id="colsRange" type="range" min="1" max="8" step="1" value="3">
        <input id="colsNumber" type="number" min="1" max="8" step="1" value="3" style="width:64px">
      </div>
      <button class="btn" id="shareBtn">
        <i class="fas fa-share-alt"></i> å¤åˆ¶åˆ†äº«é“¾æ¥
      </button>
      <span class="pill">é“¾æ¥ï¼š<span id="shareTip" style="opacity:.85"></span></span>
      <span class="pill">è®¡åˆ’IDï¼š<code id="planIdLabel"></code></span>
    </div>

    <div id="canvas" class="canvas" aria-label="æ¡Œé¢ç”»å¸ƒ"></div>
  </main>

  <!-- å¼•å…¥Font Awesomeå›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<script>
(() => {
  // å®‰å…¨æ€§æç¤ºï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®é™åˆ¶SupabaseåŒ¿åå¯†é’¥çš„æƒé™
  // å¹¶è€ƒè™‘æ·»åŠ ç”¨æˆ·è®¤è¯æœºåˆ¶ä»¥æ§åˆ¶è®¿é—®æƒé™
  const SUPABASE_URL = "https://dlgecgypzeucpfrcxdzq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsZ2VjZ3lwemV1Y3BmcmN4ZHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwODk4ODUsImV4cCI6MjA3MDY2NTg4NX0.xz0twrBoz9xh3X7LI2uati8EKlTEq3NpKhaorzuiyCE";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // å·¥å…·å‡½æ•°
  const uid = () => Math.random().toString(36).slice(2,9);
  const qs = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const escapeHtml = (s) => s.replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c]));
  
  // è§£æå®¾å®¢è¾“å…¥ï¼Œæ”¯æŒ"å§“å æ•°é‡"æ ¼å¼
  const parseGuestInput = (inputStr) => {
    // å…ˆå»é™¤å¯èƒ½çš„å¤‡æ³¨ä¿¡æ¯ï¼ˆæ‹¬å·å†…çš„å†…å®¹ï¼‰
    const nameWithoutNotes = inputStr.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').trim();
    
    // åŒ¹é…"åç§° æ•°é‡"æ ¼å¼
    const match = nameWithoutNotes.match(/^(.+)\s+(\d+)$/);
    if (match) {
      return {
        name: match[1].trim(),
        count: Math.max(1, parseInt(match[2], 10)) // ç¡®ä¿è‡³å°‘1äºº
      };
    }
    
    // é»˜è®¤1äºº
    return {
      name: nameWithoutNotes,
      count: 1
    };
  };
  
  // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
  const showToast = (message, type = 'success', duration = 3000) => {
    const container = qs('#toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    // æ ¹æ®ç±»å‹æ·»åŠ ä¸åŒå›¾æ ‡
    let icon = 'check-circle';
    if (type === 'error') icon = 'times-circle';
    if (type === 'warning') icon = 'exclamation-circle';
    
    toast.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, duration);
  };

  // è¾“å…¥éªŒè¯
  const validateInput = {
    name: (name) => {
      if (!name || name.trim() === '') return { valid: false, message: 'å§“åä¸èƒ½ä¸ºç©º' };
      if (name.length > 50) return { valid: false, message: 'å§“åè¿‡é•¿ï¼Œè¯·æ§åˆ¶åœ¨50å­—ç¬¦ä»¥å†…' };
      return { valid: true };
    },
    count: (count) => {
      const num = Number(count);
      if (isNaN(num) || num < 1 || !Number.isInteger(num)) {
        return { valid: false, message: 'äººæ•°å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°' };
      }
      if (num > 10) return { valid: false, message: 'äººæ•°è¿‡å¤šï¼Œè¯·æ§åˆ¶åœ¨10äººä»¥å†…' };
      return { valid: true };
    },
    tableName: (name) => {
      if (!name || name.trim() === '') return { valid: false, message: 'æ¡Œåä¸èƒ½ä¸ºç©º' };
      if (name.length > 30) return { valid: false, message: 'æ¡Œåè¿‡é•¿ï¼Œè¯·æ§åˆ¶åœ¨30å­—ç¬¦ä»¥å†…' };
      return { valid: true };
    },
    capacity: (cap) => {
      const num = Number(cap);
      if (isNaN(num) || num < 1 || !Number.isInteger(num)) {
        return { valid: false, message: 'å®¹é‡å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°' };
      }
      if (num > 100) return { valid: false, message: 'å®¹é‡è¿‡å¤§ï¼Œè¯·æ§åˆ¶åœ¨100ä»¥å†…' };
      return { valid: true };
    }
  };

  const hashParams = new URLSearchParams((location.hash||"").slice(1));
  let planId = hashParams.get("plan");

  // æ‰©å±•çŠ¶æ€ç»“æ„ï¼Œå¢åŠ å®¾å®¢æ•°é‡å’Œåˆ†ç±»
  const state = { 
    guests: [], // æ¯ä¸ªå®¾å®¢åŒ…å« id, name, count, category
    tables: [] 
  };
  
  const el = {
    search: qs('#search'), 
    bulkNames: qs('#bulkNames'),
    addGuestsBtn: qs('#addGuestsBtn'), 
    clearGuestsBtn: qs('#clearGuestsBtn'),
    tableName: qs('#tableName'), 
    tableCap: qs('#tableCap'), 
    addTableBtn: qs('#addTableBtn'),
    guestList: qs('#guestList'), 
    canvas: qs('#canvas'), 
    stats: qs('#stats'),
    autoSeatBtn: qs('#autoSeatBtn'), 
    shuffleBtn: qs('#shuffleBtn'),
    exportBtn: qs('#exportBtn'), 
    importFile: qs('#importFile'), 
    printBtn: qs('#printBtn'),
    resetAllBtn: qs('#resetAllBtn'),
    shareBtn: qs('#shareBtn'), 
    shareTip: qs('#shareTip'), 
    planIdLabel: qs('#planIdLabel'),
    colsRange: qs('#colsRange'), 
    colsNumber: qs('#colsNumber'),
    guestCategory: qs('#guestCategory'),
    categoryFilter: qs('#categoryFilter'),
    batchTableSelect: qs('#batchTableSelect'),
    batchMoveBtn: qs('#batchMoveBtn')
  };

  let writing = false, writeTimer = null;
  // å¢åŠ èŠ‚æµæœºåˆ¶ï¼Œä¼˜åŒ–ä¿å­˜æ€§èƒ½
  const SAVE_DELAY = 500; // 500mså†…çš„å¤šæ¬¡ä¿®æ”¹åˆå¹¶ä¸ºä¸€æ¬¡ä¿å­˜

  // æ¯æ’æ¡Œæ•°è®¾ç½®
  function setCols(n){
    n = Math.max(1, Math.min(8, Number(n)||3));
    document.documentElement.style.setProperty('--cols', n);
    el.colsRange.value = n; 
    el.colsNumber.value = n;
    localStorage.setItem('seating_cols', String(n));
  }
  
  // åˆå§‹åŒ–åˆ—æ•°
  setCols(Number(localStorage.getItem('seating_cols')||3));
  el.colsRange.oninput = e => setCols(e.target.value);
  el.colsNumber.oninput = e => setCols(e.target.value);

  // ç¡®ä¿è®¡åˆ’å­˜åœ¨
  async function ensurePlan(){
    if (planId) return planId;
    try {
      const seeded = seed();
      const { data, error } = await supabase
        .from('plans')
        .insert({ title: 'Seating Plan', state: seeded })
        .select('id')
        .single();
        
      if (error) { 
        showToast('åˆ›å»ºè®¡åˆ’å¤±è´¥ï¼š' + error.message, 'error');
        throw error; 
      }
      
      planId = data.id;
      const p = new URL(location.href); 
      p.hash = 'plan=' + planId; 
      history.replaceState(null, '', p);
      showToast('è®¡åˆ’åˆ›å»ºæˆåŠŸ');
      return planId;
    } catch (error) {
      console.error('åˆ›å»ºè®¡åˆ’å¤±è´¥:', error);
      throw error;
    }
  }

  // åŠ è½½è®¡åˆ’
  async function loadPlan(){
    try {
      const { data, error } = await supabase
        .from('plans')
        .select('state')
        .eq('id', planId)
        .single();
        
      if (error) { 
        showToast('åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
        return; 
      }
      
      Object.assign(state, (data && data.state) ? data.state : { guests:[], tables:[] });
      
      // å¤„ç†æ—§ç‰ˆæœ¬æ•°æ®å…¼å®¹æ€§ï¼ˆæ·»åŠ countå’Œcategoryå­—æ®µï¼‰
      state.guests = state.guests.map(guest => {
        if (guest.count === undefined) guest.count = 1;
        if (!guest.category) guest.category = 'other';
        return guest;
      });
      
      // æ—§è®¡åˆ’ä¸ºç©º â†’ è‡ªåŠ¨å¡«å……ç¤ºä¾‹
      const _gl = (state && state.guests) ? state.guests.length : 0; 
      const _tl = (state && state.tables) ? state.tables.length : 0; 
      
      if (_gl === 0 && _tl === 0) {
        const s = seed(); 
        state.guests = s.guests; 
        state.tables = s.tables; 
        scheduleSave();
      }
      
      render();
      showToast('è®¡åˆ’åŠ è½½æˆåŠŸ');
    } catch (error) {
      console.error('åŠ è½½è®¡åˆ’å¤±è´¥:', error);
      showToast('åŠ è½½è®¡åˆ’å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    }
  }

  // å»¶è¿Ÿä¿å­˜ï¼Œä¼˜åŒ–æ€§èƒ½
  function scheduleSave(){ 
    if (writing) return;
    clearTimeout(writeTimer);
    writeTimer = setTimeout(saveNow, SAVE_DELAY);
  }
  
  // æ‰§è¡Œä¿å­˜
  async function saveNow(){
    if (!planId) return;
    
    writing = true;
    try {
      // æ£€æµ‹åº§ä½å†²çªå¹¶å¤„ç†
      detectAndFixConflicts();
      
      const { error } = await supabase
        .from('plans')
        .update({ state })
        .eq('id', planId);
        
      if (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    } catch (error) {
      console.error('ä¿å­˜è¿‡ç¨‹å‡ºé”™:', error);
      showToast('ä¿å­˜è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      writing = false;
    }
  }

  // è®¢é˜…å®æ—¶æ›´æ–°
  function subscribeRealtime(){
    if (!planId) return;
    
    supabase.channel('plan-'+planId)
      .on('postgres_changes', 
        { event:'UPDATE', schema:'public', table:'plans', filter:'id=eq.'+planId }, 
        payload => {
          if (writing) return;
          
          try {
            const newState = payload.new.state || { guests:[], tables:[] };
            state.guests = newState.guests || [];
            state.tables = newState.tables || [];
            
            // å¤„ç†å…¼å®¹æ€§
            state.guests = state.guests.map(guest => {
              if (guest.count === undefined) guest.count = 1;
              if (!guest.category) guest.category = 'other';
              return guest;
            });
            
            render();
            showToast('æ•°æ®å·²æ›´æ–°', 'success', 2000);
          } catch (error) {
            console.error('å¤„ç†å®æ—¶æ›´æ–°å¤±è´¥:', error);
            showToast('æ›´æ–°æ•°æ®æ—¶å‡ºé”™', 'error');
          }
        }
      )
      .subscribe(status => {
        if (status === 'SUBSCRIBED') {
          showToast('å·²è¿æ¥åˆ°å®æ—¶åä½œ', 'success', 2000);
        } else if (status === 'CHANNEL_ERROR') {
          showToast('å®æ—¶åä½œè¿æ¥å‡ºé”™', 'error');
        }
      });
  }

  // æ£€æµ‹å¹¶å¤„ç†åº§ä½å†²çªï¼ˆåŒä¸€å®¾å®¢å‡ºç°åœ¨å¤šä¸ªåº§ä½ï¼‰
  function detectAndFixConflicts() {
    const guestCounts = {};
    
    // ç»Ÿè®¡æ¯ä¸ªå®¾å®¢å‡ºç°çš„æ¬¡æ•°
    state.tables.forEach(table => {
      table.guests.forEach(guestId => {
        guestCounts[guestId] = (guestCounts[guestId] || 0) + 1;
      });
    });
    
    // æ‰¾å‡ºå†²çªçš„å®¾å®¢
    const conflictGuests = Object.entries(guestCounts)
      .filter(([_, count]) => count > 1)
      .map(([guestId, _]) => guestId);
      
    if (conflictGuests.length > 0) {
      // å¤„ç†å†²çªï¼šåªä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°ï¼Œç§»é™¤åç»­å‡ºç°
      const seen = new Set();
      state.tables.forEach(table => {
        const newGuests = [];
        table.guests.forEach(guestId => {
          if (conflictGuests.includes(guestId)) {
            if (!seen.has(guestId)) {
              seen.add(guestId);
              newGuests.push(guestId);
            }
          } else {
            newGuests.push(guestId);
          }
        });
        table.guests = newGuests;
      });
      
      showToast(`å·²è‡ªåŠ¨ä¿®å¤ ${conflictGuests.length} ä¸ªåº§ä½å†²çª`, 'warning');
    }
    
    return conflictGuests.length > 0;
  }

  // è®¡ç®—æ¡Œå­å½“å‰å·²å ç”¨çš„åº§ä½æ•°ï¼ˆè€ƒè™‘å®¾å®¢äººæ•°ï¼‰
  function getTableOccupiedSeats(tableId) {
    const table = state.tables.find(t => t.id === tableId);
    if (!table) return 0;
    
    return table.guests.reduce((total, guestId) => {
      const guest = state.guests.find(g => g.id === guestId);
      return total + (guest ? guest.count : 1);
    }, 0);
  }

  // æ¸²æŸ“ç•Œé¢
  function render(){
    if (!planId) return;
    
    el.planIdLabel.textContent = planId;
    el.shareTip.textContent = location.href;

    // æ›´æ–°æ‰¹é‡æ“ä½œçš„æ¡Œé€‰æ‹©å™¨
    updateBatchTableSelect();
    
    const seatedIds = new Set(state.tables.flatMap(t=>t.guests));
    const filterText = (el.search.value||'').trim().toLowerCase();
    const activeCategory = qs('#categoryFilter .category-btn.active').dataset.category;
    
    // ç­›é€‰æœªå…¥åº§å®¾å®¢
    let pending = state.guests
      .filter(g => !seatedIds.has(g.id))
      .filter(g => !filterText || g.name.toLowerCase().includes(filterText))
      .filter(g => activeCategory === 'all' || g.category === activeCategory);

    // æ¸²æŸ“æœªå…¥åº§åˆ—è¡¨
    el.guestList.innerHTML = '';
    if (pending.length === 0){
      const empty = document.createElement('div'); 
      empty.style.color = 'var(--muted)'; 
      empty.style.padding = '8px'; 
      empty.textContent = 'ï¼ˆæš‚æ— æœªå…¥åº§ï¼‰';
      el.guestList.appendChild(empty);
    } else {
      for (const g of pending){
        const item = document.createElement('div');
        item.className = 'guest'; 
        item.draggable = true; 
        item.dataset.guestId = g.id;
        
        // è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
        const categoryNames = {
          family: 'å®¶äºº',
          friend: 'æœ‹å‹',
          colleague: 'åŒäº‹',
          other: 'å…¶ä»–'
        };
        
        item.innerHTML = `
          <span>ğŸ§‘</span>
          <span class="count">${g.count}äºº</span>
          <span class="category">${categoryNames[g.category]}</span>
          <span>${escapeHtml(g.name)}</span>
          <span class="tag">æ‹–æ‹½å…¥åº§</span>`;
          
        attachGuestDrag(item); 
        el.guestList.appendChild(item);
      }
    }

    // æ¸²æŸ“æ¡Œé¢
    el.canvas.innerHTML = '';
    for (const t of state.tables){
      const card = document.createElement('section'); 
      card.className = 'table-card'; 
      card.dataset.tableId = t.id;
      
      // è®¡ç®—å·²å ç”¨åº§ä½æ•°ï¼ˆè€ƒè™‘å®¾å®¢äººæ•°ï¼‰
      const occupiedSeats = getTableOccupiedSeats(t.id);
      // æ£€æŸ¥æ¡Œå­æ˜¯å¦å·²æ»¡
      const isFull = occupiedSeats >= t.capacity;
      const fullIndicator = isFull ? '<span style="color:var(--warning);margin-left:4px;">(å·²æ»¡)</span>' : '';
      
      card.innerHTML = `
        <div class="table-header">
          <span class="badge">ğŸª‘ ${escapeHtml(t.name)}${fullIndicator}</span>
          <span class="capacity">å®¹é‡ ${t.capacity} | å·²å ç”¨ ${occupiedSeats}</span>
        </div>
        <div class="table-visual"><div class="round-wrap"><div class="round">${escapeHtml(t.name)}</div></div></div>
        <div class="table-footer">
          <a class="link rename">é‡å‘½å</a> Â·
          <a class="link setcap">è®¾ç½®å®¹é‡</a> Â·
          <a class="link clear">æ¸…ç©º</a>
          <div class="spacer"></div>
          <a class="link remove-table">åˆ é™¤æ¡Œ</a>
        </div>`;

      const wrap = qs('.round-wrap', card);
      const seated = t.guests.map(id => state.guests.find(g => g.id === id)).filter(Boolean);
      const seats = t.capacity, R = 95;
      
      // æ£€æµ‹å½“å‰æ¡Œçš„å†²çªå®¾å®¢
      const tableGuestIds = t.guests;
      const duplicateIds = [];
      const idCount = {};
      
      tableGuestIds.forEach(id => {
        idCount[id] = (idCount[id] || 0) + 1;
        if (idCount[id] > 1) {
          duplicateIds.push(id);
        }
      });
      
      // æ¸²æŸ“æ¤…å­
      for (let i = 0; i < seats; i++){
        const angle = (i / seats) * 2 * Math.PI - Math.PI / 2;
        const x = Math.cos(angle) * R + 110; 
        const y = Math.sin(angle) * R + 110;
        
        const chair = document.createElement('div');
        chair.className = 'chair';
        chair.style.left = (x - 32) + 'px'; 
        chair.style.top = (y - 14) + 'px';
        
        // æŸ¥æ‰¾è¿™ä¸ªåº§ä½æ˜¯å¦è¢«å ç”¨
        let occupiedBy = null;
        let currentSeat = 0;
        
        // è®¡ç®—æ¯ä¸ªå®¾å®¢å ç”¨çš„åº§ä½èŒƒå›´
        for (const guest of seated) {
          if (i >= currentSeat && i < currentSeat + guest.count) {
            occupiedBy = guest;
            break;
          }
          currentSeat += guest.count;
        }
        
        if (occupiedBy) {
          // æ ‡è®°å†²çªçš„åº§ä½
          const isConflicted = duplicateIds.includes(occupiedBy.id) || 
            state.tables.some(otherTable => 
              otherTable.id !== t.id && otherTable.guests.includes(occupiedBy.id)
            );
          
          if (isConflicted) {
            chair.classList.add('conflict');
          }
          
          // åªåœ¨ç¬¬ä¸€ä¸ªåº§ä½æ˜¾ç¤ºå®¾å®¢åç§°å’Œåˆ é™¤æŒ‰é’®
          const isFirstSeat = i === currentSeat;
          chair.innerHTML = isFirstSeat 
            ? `<span>${escapeHtml(shortName(occupiedBy.name))}</span><span class="count">${occupiedBy.count}</span><span class="kick">Ã—</span>`
            : `<span>${escapeHtml(shortName(occupiedBy.name))}</span><span class="count">+${i - currentSeat}</span>`;
          
          if (isFirstSeat) {
            const kick = chair.querySelector('.kick');
            kick.onclick = (ev) => { 
              ev.stopPropagation(); 
              t.guests = t.guests.filter(id => id !== occupiedBy.id);
              scheduleSave(); 
              render();
              showToast(`å·²å°† ${occupiedBy.name} ä¸€è¡Œ(${occupiedBy.count}äºº)ä» ${t.name} ç§»é™¤`);
            };
            
            chair.draggable = true; 
            chair.dataset.guestId = occupiedBy.id; 
            chair.dataset.tableId = t.id; 
            attachGuestDrag(chair);
          }
        } else {
          chair.classList.add('empty'); 
          chair.textContent = 'ç©ºä½';
        }
        
        wrap.appendChild(chair);
      }

      // å…è®¸æŠŠå®¾å®¢æ‹–æ‹½åˆ°æ•´å¼ æ¡Œ
      wrap.addEventListener('dragover', e => { 
        e.preventDefault();
        wrap.style.backgroundColor = 'rgba(255,255,255,0.05)';
      });
      
      wrap.addEventListener('dragleave', () => {
        wrap.style.backgroundColor = '';
      });
      
      wrap.addEventListener('drop', e => {
        e.preventDefault();
        wrap.style.backgroundColor = '';
        
        const gid = draggingId || e.dataTransfer.getData('text/plain'); 
        if (!gid) return;
        
        // æŸ¥æ‰¾å®¾å®¢ä¿¡æ¯
        const guest = state.guests.find(g => g.id === gid);
        if (!guest) return;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´å®¹çº³è¿™ç»„å®¾å®¢
        const occupiedSeats = getTableOccupiedSeats(t.id);
        if (occupiedSeats + guest.count > t.capacity) {
          showToast(`${t.name} ç©ºé—´ä¸è¶³ï¼Œæ— æ³•å®¹çº³ ${guest.name} ä¸€è¡Œ(${guest.count}äºº)`, 'warning');
          return;
        }
        
        // ä»åŸæ¡Œç§»é™¤
        const fromTable = state.tables.find(tt => tt.guests.includes(gid));
        if (fromTable && fromTable.id !== t.id) {
          fromTable.guests = fromTable.guests.filter(id => id !== gid);
        }
        
        // æ·»åŠ åˆ°æ–°æ¡Œ
        if (!t.guests.includes(gid)) {
          t.guests.push(gid);
          scheduleSave(); 
          render();
          showToast(`å·²å°† ${guest.name} ä¸€è¡Œ(${guest.count}äºº)å®‰æ’åˆ° ${t.name}`);
        }
      });

      // æ¡Œæ“ä½œäº‹ä»¶
      qs('.rename', card).onclick = () => {
        const name = prompt('æ¡Œåï¼š', t.name); 
        if (name && name.trim()) {
          const validation = validateInput.tableName(name);
          if (!validation.valid) {
            showToast(validation.message, 'error');
            return;
          }
          
          t.name = name.trim(); 
          scheduleSave(); 
          render();
          showToast(`å·²é‡å‘½åä¸º ${t.name}`);
        } 
      };
      
      qs('.setcap', card).onclick = () => {
        const cap = prompt('å®¹é‡ï¼ˆåº§ä½æ•°ï¼‰ï¼š', t.capacity); 
        const n = Number(cap); 
        
        const validation = validateInput.capacity(n);
        if (!validation.valid) {
          showToast(validation.message, 'error');
          return;
        }
        
        // æ£€æŸ¥æ–°å®¹é‡æ˜¯å¦èƒ½å®¹çº³å½“å‰å®¾å®¢
        const occupiedSeats = getTableOccupiedSeats(t.id);
        let removedGuests = [];
        
        if (n < occupiedSeats) {
          // å®¹é‡ä¸è¶³ï¼Œéœ€è¦ç§»é™¤å®¾å®¢
          let remainingCapacity = n;
          const newGuests = [];
          
          for (const guestId of t.guests) {
            const guest = state.guests.find(g => g.id === guestId);
            if (!guest) continue;
            
            if (remainingCapacity >= guest.count) {
              newGuests.push(guestId);
              remainingCapacity -= guest.count;
            } else {
              removedGuests.push(guest);
            }
          }
          
          t.guests = newGuests;
        }
        
        t.capacity = n; 
        scheduleSave(); 
        render();
        
        let message = `å·²è®¾ç½® ${t.name} å®¹é‡ä¸º ${n}`;
        if (removedGuests.length > 0) {
          message += `ï¼Œå› å®¹é‡ä¸è¶³å·²ç§»é™¤ ${removedGuests.length} ç»„å®¾å®¢`;
        }
        showToast(message);
      };
      
      qs('.clear', card).onclick = () => {
        if (confirm(`æ¸…ç©º ${t.name} çš„å…¥åº§ï¼Ÿ`)) {
          const count = t.guests.length;
          const peopleCount = getTableOccupiedSeats(t.id);
          t.guests = []; 
          scheduleSave(); 
          render();
          showToast(`å·²æ¸…ç©º ${t.name} çš„ ${count} ç»„å®¾å®¢ï¼ˆå…±${peopleCount}äººï¼‰`);
        }
      };
      
      qs('.table-footer .remove-table', card).onclick = () => {
        if (confirm(`åˆ é™¤æ¡Œå­â€œ${t.name}â€ï¼Ÿ`)) {
          state.tables = state.tables.filter(x => x.id !== t.id); 
          scheduleSave(); 
          render();
          showToast(`å·²åˆ é™¤ ${t.name}`);
        }
      };

      el.canvas.appendChild(card);
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    const totalGroups = state.guests.length;
    const totalPeople = state.guests.reduce((sum, guest) => sum + guest.count, 0);
    const seatedPeople = state.tables.reduce((sum, table) => {
      return sum + table.guests.reduce((tableSum, guestId) => {
        const guest = state.guests.find(g => g.id === guestId);
        return tableSum + (guest ? guest.count : 0);
      }, 0);
    }, 0);
    const unseatedPeople = totalPeople - seatedPeople;
    const tableCount = state.tables.length;
    const fullTables = state.tables.filter(t => getTableOccupiedSeats(t.id) >= t.capacity).length;
    
    // åˆ†ç±»ç»Ÿè®¡
    const categoryStats = {
      family: 0,
      friend: 0,
      colleague: 0,
      other: 0
    };
    
    state.guests.forEach(guest => {
      if (categoryStats.hasOwnProperty(guest.category)) {
        categoryStats[guest.category] += guest.count;
      }
    });
    
    el.stats.innerHTML = `
      <span class="pill">æ€»ç»„æ•°ï¼š${totalGroups}</span>
      <span class="pill">æ€»äººæ•°ï¼š${totalPeople}</span>
      <span class="pill">å·²å…¥åº§ï¼š${seatedPeople}</span>
      <span class="pill">æœªå…¥åº§ï¼š${unseatedPeople}</span>
      <span class="pill">æ¡Œæ•°ï¼š${tableCount}</span>
      <span class="pill">æ»¡å‘˜æ¡Œï¼š${fullTables}</span>
      <span class="pill">å®¶äººï¼š${categoryStats.family}</span>
      <span class="pill">æœ‹å‹ï¼š${categoryStats.friend}</span>`;
  }

  // æ›´æ–°æ‰¹é‡æ“ä½œçš„æ¡Œé€‰æ‹©å™¨
  function updateBatchTableSelect() {
    el.batchTableSelect.innerHTML = '<option value="">é€‰æ‹©ç›®æ ‡æ¡Œ...</option>';
    
    state.tables.forEach(table => {
      const occupiedSeats = getTableOccupiedSeats(table.id);
      const availableSeats = table.capacity - occupiedSeats;
      
      const option = document.createElement('option');
      option.value = table.id;
      option.textContent = `${table.name} (${occupiedSeats}/${table.capacity})`;
      // å·²æ»¡çš„æ¡Œå­ç¦ç”¨é€‰æ‹©
      option.disabled = availableSeats <= 0;
      el.batchTableSelect.appendChild(option);
    });
  }

  // ç®€åŒ–å§“åæ˜¾ç¤º
  function shortName(s) { 
    s = s.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').trim(); 
    return s.length <= 4 ? s : s.slice(0, 4); 
  }

  // æ‹–æ‹½ç›¸å…³
  let draggingId = null;
  function attachGuestDrag(node) {
    node.addEventListener('dragstart', e => {
      draggingId = node.dataset.guestId;
      node.classList.add('dragging');
      e.dataTransfer.setData('text/plain', draggingId);
      e.dataTransfer.effectAllowed = 'move';
    });
    
    node.addEventListener('dragend', () => {
      draggingId = null; 
      node.classList.remove('dragging');
      // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ‹–æ‹½æ ·å¼
      qsa('.round-wrap').forEach(wrap => {
        wrap.style.backgroundColor = '';
      });
    });
  }

  // ç»‘å®šæŒ‰é’®äº‹ä»¶
  function bindEvents() {
    // æ·»åŠ å®¾å®¢
    el.addGuestsBtn.onclick = () => {
      const lines = el.bulkNames.value
        .split(/\n/)
        .map(s => s.trim())
        .filter(Boolean);
        
      if (lines.length === 0) {
        showToast('è¯·ç²˜è´´è‡³å°‘ä¸€ä¸ªå§“å', 'warning');
        return;
      }
      
      const category = el.guestCategory.value;
      let addedCount = 0;
      
      for (const line of lines) {
        // è§£æ"å§“å æ•°é‡"æ ¼å¼
        const { name, count } = parseGuestInput(line);
        
        // éªŒè¯
        const nameValidation = validateInput.name(name);
        if (!nameValidation.valid) {
          showToast(nameValidation.message + `: ${line}`, 'error');
          continue;
        }
        
        const countValidation = validateInput.count(count);
        if (!countValidation.valid) {
          showToast(countValidation.message + `: ${line}`, 'error');
          continue;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå®¾å®¢
        const exists = state.guests.some(g => g.name.trim() === name.trim());
        if (exists) {
          showToast(`å·²å­˜åœ¨åŒåå®¾å®¢: ${name}`, 'warning');
          continue;
        }
        
        state.guests.push({ 
          id: uid(), 
          name,
          count,
          category
        });
        addedCount++;
      }
      
      el.bulkNames.value = ''; 
      scheduleSave(); 
      render();
      
      if (addedCount > 0) {
        showToast(`å·²æ·»åŠ  ${addedCount} ç»„å®¾å®¢`);
      }
    };
    
    // æ¸…ç©ºæœªå…¥åº§
    el.clearGuestsBtn.onclick = () => {
      const seated = new Set(state.tables.flatMap(t => t.guests));
      const pendingCount = state.guests.filter(g => !seated.has(g.id)).length;
      const pendingPeopleCount = state.guests
        .filter(g => !seated.has(g.id))
        .reduce((sum, guest) => sum + guest.count, 0);
      
      if (pendingCount === 0) {
        showToast('æ²¡æœ‰æœªå…¥åº§çš„å®¾å®¢', 'info');
        return;
      }
      
      if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœªå…¥åº§çš„ ${pendingCount} ç»„å®¾å®¢ï¼ˆå…±${pendingPeopleCount}äººï¼‰å—ï¼Ÿï¼ˆå·²åœ¨æ¡Œä¸Šçš„ä¸å—å½±å“ï¼‰`)) {
        state.guests = state.guests.filter(g => seated.has(g.id)); 
        scheduleSave(); 
        render();
        showToast(`å·²æ¸…ç©º ${pendingCount} ç»„æœªå…¥åº§å®¾å®¢ï¼ˆå…±${pendingPeopleCount}äººï¼‰`);
      }
    };
    
    // æ·»åŠ æ¡Œå­
    el.addTableBtn.onclick = () => {
      const name = (el.tableName.value.trim() || `${state.tables.length + 1}å·æ¡Œ`);
      const cap = Number(el.tableCap.value);
      
      const nameValidation = validateInput.tableName(name);
      if (!nameValidation.valid) {
        showToast(nameValidation.message, 'error');
        return;
      }
      
      const capValidation = validateInput.capacity(cap);
      if (!capValidation.valid) {
        showToast(capValidation.message, 'error');
        return;
      }
      
      state.tables.push({ 
        id: uid(), 
        name, 
        capacity: cap, 
        guests: [] 
      });
      
      el.tableName.value = ''; 
      scheduleSave(); 
      render();
      showToast(`å·²æ·»åŠ  ${name}`);
    };
    
    // è‡ªåŠ¨æ’åº§
    el.autoSeatBtn.onclick = () => {
      const seated = new Set(state.tables.flatMap(t => t.guests));
      const queue = state.guests.filter(g => !seated.has(g.id));
      
      if (queue.length === 0) {
        showToast('æ²¡æœ‰æœªå…¥åº§çš„å®¾å®¢', 'info');
        return;
      }
      
      // å¢å¼ºçš„è‡ªåŠ¨æ’åº§é€»è¾‘ï¼šæŒ‰åˆ†ç±»ä¼˜å…ˆæ’åº§
      // å…ˆæŒ‰åˆ†ç±»åˆ†ç»„
      const categoryGroups = {};
      queue.forEach(guest => {
        if (!categoryGroups[guest.category]) {
          categoryGroups[guest.category] = [];
        }
        categoryGroups[guest.category].push(guest);
      });
      
      // ä¼˜å…ˆæ’å®¶äººï¼Œç„¶åæ˜¯æœ‹å‹ï¼Œå†æ˜¯åŒäº‹ï¼Œæœ€åæ˜¯å…¶ä»–
      const priorityOrder = ['family', 'friend', 'colleague', 'other'];
      const orderedQueue = [];
      
      priorityOrder.forEach(category => {
        if (categoryGroups[category]) {
          orderedQueue.push(...categoryGroups[category]);
        }
      });
      
      // åˆ†é…åˆ°æ¡Œå­
      let guestIndex = 0;
      for (const t of state.tables) {
        while (guestIndex < orderedQueue.length) {
          const guest = orderedQueue[guestIndex];
          const occupiedSeats = getTableOccupiedSeats(t.id);
          
          // æ£€æŸ¥æ˜¯å¦èƒ½å®¹çº³å½“å‰å®¾å®¢ç»„
          if (occupiedSeats + guest.count <= t.capacity) {
            t.guests.push(guest.id);
            guestIndex++;
          } else {
            // ç©ºé—´ä¸è¶³ï¼Œå°è¯•ä¸‹ä¸€æ¡Œ
            break;
          }
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆ†é…çš„å®¾å®¢
      const unassigned = orderedQueue.slice(guestIndex);
      const unassignedGroups = unassigned.length;
      const unassignedPeople = unassigned.reduce((sum, guest) => sum + guest.count, 0);
      
      scheduleSave(); 
      render();
      
      let message = `å·²è‡ªåŠ¨å®‰æ’ ${guestIndex} ç»„å®¾å®¢å…¥åº§ï¼ˆå…±${orderedQueue.slice(0, guestIndex).reduce((sum, g) => sum + g.count, 0)}äººï¼‰`;
      if (unassignedGroups > 0) {
        message += `ï¼Œå°šæœ‰ ${unassignedGroups} ç»„å®¾å®¢ï¼ˆå…±${unassignedPeople}äººï¼‰æ— æ³•å®‰æ’ï¼ˆæ¡Œå­å·²æ»¡ï¼‰`;
      }
      
      showToast(message);
    };
    
    // æ‰“æ•£æœªå…¥åº§
    el.shuffleBtn.onclick = () => {
      const seated = new Set(state.tables.flatMap(t => t.guests));
      const pending = state.guests.filter(g => !seated.has(g.id));
      
      if (pending.length <= 1) {
        showToast('æœªå…¥åº§å®¾å®¢å¤ªå°‘ï¼Œæ— éœ€æ‰“æ•£', 'info');
        return;
      }
      
      // éšæœºæ‰“ä¹±é¡ºåº
      for (let i = pending.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pending[i], pending[j]] = [pending[j], pending[i]];
      }
      
      // ä¿æŒå·²å…¥åº§å®¾å®¢é¡ºåºï¼Œæœªå…¥åº§çš„æ‰“ä¹±
      const remains = state.guests.filter(g => seated.has(g.id)); 
      state.guests = remains.concat(pending);
      
      scheduleSave(); 
      render();
      showToast('å·²éšæœºæ‰“ä¹±æœªå…¥åº§å®¾å®¢é¡ºåº');
    };
    
    // å¯¼å‡º
    el.exportBtn.onclick = () => {
      try {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], {type: 'application/json;charset=utf-8'});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob);
        
        const dateStr = new Date().toISOString().slice(0, 10);
        a.download = `åº§ä½è§„åˆ’-${dateStr}.json`; 
        a.click();
        URL.revokeObjectURL(a.href);
        
        showToast('å¯¼å‡ºæˆåŠŸ');
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    };
    
    // å¯¼å…¥
    el.importFile.onchange = (ev) => {
      const file = ev.target.files[0]; 
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const s = JSON.parse(reader.result);
          
          if (!s || !Array.isArray(s.guests) || !Array.isArray(s.tables)) {
            throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
          }
          
          // éªŒè¯å¯¼å…¥çš„æ•°æ®
          s.guests.forEach((guest, index) => {
            if (!guest.id || !guest.name || guest.count === undefined) {
              throw new Error(`å®¾å®¢æ•°æ®æ— æ•ˆï¼ˆç´¢å¼• ${index}ï¼‰`);
            }
          });
          
          s.tables.forEach((table, index) => {
            if (!table.id || !table.name || typeof table.capacity !== 'number' || !Array.isArray(table.guests)) {
              throw new Error(`æ¡Œå­æ•°æ®æ— æ•ˆï¼ˆç´¢å¼• ${index}ï¼‰`);
            }
          });
          
          // å¤„ç†åˆ†ç±»å’Œæ•°é‡æ•°æ®
          s.guests = s.guests.map(guest => {
            if (guest.count === undefined) guest.count = 1;
            if (!guest.category) guest.category = 'other';
            return guest;
          });
          
          state.guests = s.guests; 
          state.tables = s.tables; 
          scheduleSave(); 
          render();
          showToast('å¯¼å…¥æˆåŠŸ');
        } catch (e) {
          showToast('å¯¼å…¥å¤±è´¥ï¼š' + e.message, 'error');
        }
        ev.target.value = '';
      };
      reader.readAsText(file, 'utf-8');
    };
    
    // æ‰“å°
    el.printBtn.onclick = () => {
      // æ‰“å°å‰å…ˆç¡®ä¿æ²¡æœ‰å†²çª
      const hasConflicts = detectAndFixConflicts();
      if (hasConflicts) {
        // å¦‚æœæœ‰å†²çªï¼Œä¿®å¤åå†æ‰“å°
        saveNow().then(() => {
          window.print();
        });
      } else {
        window.print();
      }
    };
    
    // é‡ç½®å…¨éƒ¨
    el.resetAllBtn.onclick = () => {
      if (confirm('ç¡®å®šè¦é‡ç½®å…¨éƒ¨æ•°æ®å—ï¼Ÿï¼ˆæ¸…ç©ºæ‰€æœ‰æ¡Œå­ä¸åå•ï¼Œæ¢å¤ä¸ºåˆå§‹ç¤ºä¾‹æ•°æ®ï¼‰')) {
        const s = seed(); 
        state.guests = s.guests; 
        state.tables = s.tables; 
        scheduleSave(); 
        render();
        showToast('å·²é‡ç½®å…¨éƒ¨æ•°æ®');
      }
    };
    
    // æœç´¢
    el.search.oninput = () => render();
    
    // åˆ†äº«é“¾æ¥
    el.shareBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(location.href);
        showToast('å·²å¤åˆ¶åˆ†äº«é“¾æ¥');
      } catch {
        prompt('è¯·å¤åˆ¶æ­¤é“¾æ¥ï¼š', location.href);
      }
    };
    
    // åˆ†ç±»ç­›é€‰
    qsa('#categoryFilter .category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        qsa('#categoryFilter .category-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
      });
    });
    
    // æ‰¹é‡ç§»åŠ¨
    el.batchMoveBtn.onclick = () => {
      const targetTableId = el.batchTableSelect.value;
      if (!targetTableId) {
        showToast('è¯·å…ˆé€‰æ‹©ç›®æ ‡æ¡Œ', 'warning');
        return;
      }
      
      const targetTable = state.tables.find(t => t.id === targetTableId);
      if (!targetTable) {
        showToast('ç›®æ ‡æ¡Œä¸å­˜åœ¨', 'error');
        return;
      }
      
      const seated = new Set(state.tables.flatMap(t => t.guests));
      const pending = state.guests.filter(g => !seated.has(g.id));
      
      if (pending.length === 0) {
        showToast('æ²¡æœ‰æœªå…¥åº§çš„å®¾å®¢å¯ç§»åŠ¨', 'info');
        return;
      }
      
      // è®¡ç®—å¯ç§»åŠ¨çš„å®¾å®¢ç»„
      const availableSeats = targetTable.capacity - getTableOccupiedSeats(targetTableId);
      if (availableSeats <= 0) {
        showToast('ç›®æ ‡æ¡Œå·²åæ»¡', 'error');
        return;
      }
      
      // å°è¯•æŒ‰é¡ºåºæ·»åŠ å®¾å®¢ï¼Œç›´åˆ°æ¡Œå­æ»¡
      let remainingSeats = availableSeats;
      const canMove = [];
      
      for (const guest of pending) {
        if (guest.count <= remainingSeats) {
          canMove.push(guest);
          remainingSeats -= guest.count;
        } else {
          // ç©ºé—´ä¸è¶³ï¼Œæ— æ³•æ·»åŠ å½“å‰å®¾å®¢ç»„
          break;
        }
      }
      
      if (canMove.length === 0) {
        showToast('ç›®æ ‡æ¡Œç©ºé—´ä¸è¶³ï¼Œæ— æ³•å®¹çº³ä»»ä½•æœªå…¥åº§å®¾å®¢', 'warning');
        return;
      }
      
      const canMovePeople = canMove.reduce((sum, guest) => sum + guest.count, 0);
      
      if (!confirm(`ç¡®å®šè¦å°† ${canMove.length} ç»„å®¾å®¢ï¼ˆå…±${canMovePeople}äººï¼‰ç§»åŠ¨åˆ° ${targetTable.name} å—ï¼Ÿ`)) {
        return;
      }
      
      // æ‰§è¡Œç§»åŠ¨
      canMove.forEach(guest => {
        targetTable.guests.push(guest.id);
      });
      
      scheduleSave();
      render();
      showToast(`å·²å°† ${canMove.length} ç»„å®¾å®¢ï¼ˆå…±${canMovePeople}äººï¼‰ç§»åŠ¨åˆ° ${targetTable.name}`);
    };
  }

  // ç”Ÿæˆåˆå§‹ç¤ºä¾‹æ•°æ®
  function seed() {
    // å¸¦äººæ•°å’Œåˆ†ç±»çš„ç¤ºä¾‹å®¾å®¢
    const guests = [
      { id: uid(), name: 'å¼ ä¸‰', count: 2, category: 'family' },
      { id: uid(), name: 'æå››', count: 4, category: 'friend' },
      { id: uid(), name: 'ç‹äº”', count: 1, category: 'colleague' },
      { id: uid(), name: 'èµµå…­', count: 3, category: 'friend' },
      { id: uid(), name: 'å°çº¢', count: 2, category: 'family' },
      { id: uid(), name: 'å°æ˜', count: 1, category: 'family' },
      { id: uid(), name: 'å°èŠ³', count: 2, category: 'friend' },
      { id: uid(), name: 'é™ˆä¼Ÿ', count: 5, category: 'colleague' },
      { id: uid(), name: 'åˆ˜å¼º', count: 1, category: 'colleague' },
      { id: uid(), name: 'å‘¨æ°', count: 2, category: 'other' }
    ];
    
    return {
      guests,
      tables: [
        { id: uid(), name: '1å·æ¡Œ', capacity: 8, guests: [] },
        { id: uid(), name: '2å·æ¡Œ', capacity: 8, guests: [] },
        { id: uid(), name: '3å·æ¡Œ', capacity: 10, guests: [] },
        { id: uid(), name: 'äº²å‹æ¡ŒA', capacity: 12, guests: [] }
      ]
    };
  }

  // åˆå§‹åŒ–åº”ç”¨
  (async () => {
    try {
      // ç»‘å®šäº‹ä»¶
      bindEvents();
      
      // ç¡®ä¿æœ‰è®¡åˆ’
      await ensurePlan();
      
      // åŠ è½½çŠ¶æ€å¹¶æ¸²æŸ“
      await loadPlan();
      
      // è®¢é˜…å®æ—¶æ›´æ–°
      subscribeRealtime();
    } catch (error) {
      console.error('åˆå§‹åŒ–å¤±è´¥:', error);
      showToast('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    }
  })();
})();
</script>
</body>
</html>
