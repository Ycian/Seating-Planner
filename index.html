<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>宾客座位规划（支持人数 | 实时协作）</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  :root{ 
    --bg:#0f1220; 
    --panel:#171b2c; 
    --accent:#6aa7ff; 
    --accent-2:#9f7bff; 
    --text:#e7ecff; 
    --muted:#9aa4c7; 
    --card:#1c2140; 
    --chip:#242a52; 
    --border:rgba(255,255,255,.08); 
    --cols:3; 
    --success:#4cd964;
    --warning:#ffcc00;
    --error:#ff3b30;
    --conflict-highlight: rgba(255, 59, 48, 0.15);
    --family:#4cd964;
    --friend:#ffcc00;
    --colleague:#6aa7ff;
    --other:#9f7bff;
  }
  *{box-sizing:border-box} 
  html,body{height:100%}
  body{ 
    margin:0; 
    background: radial-gradient(1200px 600px at 20% -10%, #1a2040 0, #0f1220 70%), var(--bg); 
    color:var(--text); 
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif; 
    display:flex; 
    gap:12px; 
    padding:12px; 
    overflow:hidden; 
  }
  .sidebar{ 
    width:320px; 
    min-width:260px; 
    max-width:380px; 
    background:var(--panel); 
    border:1px solid var(--border); 
    border-radius:16px; 
    padding:14px; 
    display:flex; 
    flex-direction:column; 
    gap:14px; 
    overflow:hidden;
  }
  
  .sidebar-section {
    background: var(--card);
    border-radius: 12px;
    padding: 12px;
    border: 1px solid var(--border);
    transition: all 0.2s;
  }
  
  .sidebar-section:hover {
    border-color: rgba(255,255,255,0.15);
  }
  
  h1{font-size:16px; margin:0 0 8px 0; letter-spacing:.5px; display:flex; align-items:center; gap:6px}
  h1 i {color: var(--accent);}
  
  .controls,.stats{display:grid; gap:8px}
  .controls input[type="text"], 
  .controls input[type="number"], 
  textarea, 
  input[type="file"]{ 
    width:100%; 
    padding:10px 12px; 
    border-radius:10px; 
    border:1px solid var(--border); 
    background:#0f1330; 
    color:var(--text); 
    outline:none; 
    transition:border-color 0.2s;
  }
  .controls input:focus, textarea:focus {
    border-color: var(--accent);
  }
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .btn{ 
    appearance:none; 
    border:none; 
    cursor:pointer; 
    padding:10px 12px; 
    border-radius:10px; 
    color:white; 
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); 
    box-shadow:0 6px 20px rgba(106,167,255,.25); 
    transition:.15s transform ease,.15s filter ease,.15s opacity ease; 
    white-space:nowrap; 
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
  }
  .btn:hover{filter:brightness(1.05)} 
  .btn:active{transform:translateY(1px)} 
  .btn.ghost{background:transparent; border:1px solid var(--border); color:var(--text); box-shadow:none}
  .btn.warn{background:linear-gradient(135deg,#ff8a8a,#ff6b6b)}
  
  .guest-list-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 200;
  }
  .guest-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px;
    border: 1px dashed var(--border);
    border-radius: 12px;
    background:rgba(0,0,0,.12);
    scrollbar-width: thin;
    scrollbar-color: var(--accent) transparent;
  }
  .guest-list::-webkit-scrollbar {width: 6px;}
  .guest-list::-webkit-scrollbar-track {background: transparent;}
  .guest-list::-webkit-scrollbar-thumb {
    background-color: var(--accent);
    border-radius: 3px;
  }
  
  .guest{
    user-select:none; 
    display:flex; 
    align-items:center; 
    gap:8px; 
    padding:8px 10px; 
    border-radius:10px; 
    background:var(--chip); 
    border:1px solid var(--border);
    transition:all 0.2s;
  }
  .guest:hover {border-color: rgba(255,255,255,0.2);}
  .guest.dragging{opacity:.6; transform:scale(0.98)} 
  .guest .tag{font-size:12px; color:var(--muted); margin-left:auto}
  .guest .count {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    margin-right: 4px;
  }
  .guest .category {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
    margin-right: 4px;
  }
  .category.family { background-color: rgba(76, 217, 100, 0.2); color: var(--family); }
  .category.friend { background-color: rgba(255, 204, 0, 0.2); color: var(--friend); }
  .category.colleague { background-color: rgba(106, 167, 255, 0.2); color: var(--colleague); }
  .category.other { background-color: rgba(159, 123, 255, 0.2); color: var(--other); }
  
  .search{ 
    padding:8px 10px; 
    border-radius:10px; 
    border:1px solid var(--border); 
    background:#0f1330; 
    color:var(--text);
    transition:border-color 0.2s;
    width: 100%;
  }
  .search:focus {border-color: var(--accent);}
  .main{flex:1; min-width:0; display:flex; flex-direction:column; gap:10px}
  .toolbar{ 
    background:var(--panel); 
    border:1px solid var(--border); 
    border-radius:16px; 
    padding:10px; 
    display:flex; 
    gap:8px; 
    flex-wrap:wrap; 
    align-items:center 
  }
  .stats{ 
    display:flex; 
    align-items:center; 
    gap:10px; 
    flex-wrap:wrap; 
    margin-left:auto 
  }
  .pill{ 
    padding:8px 10px; 
    border-radius:999px; 
    background:var(--chip); 
    border:1px solid var(--border); 
    color:var(--text) 
  }
  .pill.highlight {
    background: linear-gradient(135deg, rgba(106, 167, 255, 0.2), rgba(159, 123, 255, 0.2));
    border-color: var(--accent);
  }
  .canvas{ 
    flex:1; 
    overflow:auto; 
    padding:12px; 
    display:grid; 
    grid-template-columns: repeat(var(--cols), minmax(260px,1fr)); 
    gap:12px 
  }
  .table-card{ 
    background:var(--card); 
    border:1px solid var(--border); 
    border-radius:16px; 
    padding:12px; 
    display:flex; 
    flex-direction:column; 
    gap:10px;
    transition:all 0.2s;
  }
  .table-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .table-card.has-conflict {
    background: var(--conflict-highlight);
    border-color: var(--error);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); }
    70% { box-shadow: 0 0 0 8px rgba(255, 59, 48, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
  }
  
  .table-header{ display:flex; align-items:center; gap:10px }
  .badge{ 
    font-weight:600; 
    padding:6px 10px; 
    border-radius:999px; 
    background:linear-gradient(135deg,#27305d,#1f2550); 
    border:1px solid var(--border) 
  }
  .capacity{ margin-left:auto; font-size:12px; color:var(--muted) }
  .table-visual{ display:flex; align-items:center; justify-content:center; padding:10px 0 6px }
  .round-wrap{ position:relative; width:220px; height:220px; margin:auto }
  .round{ 
    position:absolute; 
    left:50%; top:50%; 
    transform:translate(-50%,-50%); 
    width:120px; height:120px; 
    border-radius:50%; 
    background:#2a2f68; 
    border:2px solid var(--border); 
    box-shadow: inset 0 0 0 4px rgba(255,255,255,.05); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    color:#cfe3ff; 
    font-weight:600 
  }
  .chair{ 
    position:absolute; 
    width:64px; height:28px; 
    border-radius:14px; 
    background:#222861; 
    border:1px solid var(--border); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    padding:0 6px; 
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis;
    transition:all 0.2s;
  }
  .chair:hover {transform: scale(1.05); z-index: 10;}
  .chair.empty{ opacity:.45; font-size:12px; color:var(--muted) }
  .chair.conflict {
    background: rgba(255, 59, 48, 0.3);
    border-color: var(--error);
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
  }
  
  @keyframes shake {
    10%, 90% { transform: translateX(-1px) scale(1.05); }
    20%, 80% { transform: translateX(2px) scale(1.05); }
    30%, 50%, 70% { transform: translateX(-3px) scale(1.05); }
    40%, 60% { transform: translateX(3px) scale(1.05); }
  }
  
  .chair .count {
    font-size: 10px;
    margin-left: 4px;
    color: rgba(255, 255, 255, 0.7);
  }
  .chair .kick{ 
    margin-left:6px; 
    text-decoration:underline; 
    cursor:pointer; 
    color:#f8b4b4; 
    font-size:12px;
    opacity:0.7;
    transition:opacity 0.2s;
  }
  .chair:hover .kick {opacity:1;}
  .table-footer{ display:flex; align-items:center; gap:6px; color:var(--muted) }
  .spacer{flex:1} 
  .link{
    color:var(--accent); 
    cursor:pointer; 
    text-decoration:underline; 
    font-size:12px;
    transition:color 0.2s;
  }
  .link:hover {color: var(--accent-2);}
  .grid-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap } 
  .grid-controls input[type="range"]{ width:160px }
  
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .toast {
    padding: 12px 16px;
    border-radius: 8px;
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 8px;
    animation: toastIn 0.3s ease forwards, toastOut 0.3s ease 2.7s forwards;
    max-width: 300px;
  }
  .toast.success { background-color: var(--success); }
  .toast.error { background-color: var(--error); }
  .toast.warning { background-color: var(--warning); color: #333; }
  .toast.info { background-color: var(--accent); }
  
  @keyframes toastIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes toastOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  .category-selector {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
    flex-wrap: wrap;
    padding: 6px;
    background: rgba(0,0,0,0.1);
    border-radius: 8px;
  }
  .category-btn {
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    background: var(--chip);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .category-btn::before {content: '●'; font-size: 8px;}
  .category-btn.family::before { color: var(--family); }
  .category-btn.friend::before { color: var(--friend); }
  .category-btn.colleague::before { color: var(--colleague); }
  .category-btn.other::before { color: var(--other); }
  .category-btn:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-1px);
  }
  .category-btn.active {
    background: rgba(106, 167, 255, 0.2);
    border-color: var(--accent);
    color: var(--accent);
    font-weight: 500;
  }
  
  .batch-actions {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed var(--border);
  }
  
  .filter-result {
    font-size: 12px;
    color: var(--muted);
    margin: 4px 0 8px 0;
    padding: 4px 8px;
    border-radius: 6px;
    background: rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
  }
  
  .import-preview {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    margin: 8px 0;
    background: rgba(0,0,0,0.1);
  }
  .import-preview-item {
    padding: 4px 0;
    border-bottom: 1px dashed var(--border);
    font-size: 12px;
  }
  .import-preview-item:last-child {border-bottom: none;}
  .import-preview .error {color: var(--error);}
  
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .modal-backdrop.active {
    opacity: 1;
    pointer-events: all;
  }
  .modal {
    background: var(--panel);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    padding: 20px;
    border: 1px solid var(--border);
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }
  .modal-backdrop.active .modal {transform: translateY(0);}
  .modal h2 {
    margin-top: 0;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .modal h2 i {color: var(--error);}
  .modal p {color: var(--muted);}
  .conflict-item {
    background: var(--card);
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid var(--border);
  }
  .conflict-item.theirs {border-left: 3px solid var(--accent);}
  .conflict-item.mine {border-left: 3px solid var(--success);}
  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  
  .stats-chart-container {
    height: 200px;
    margin: 10px 0;
    position: relative;
  }
  
  .loading-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1500;
    background: var(--panel);
    padding: 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    border: 1px solid var(--border);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .loading-indicator.active {
    opacity: 1;
    pointer-events: all;
  }
  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {to { transform: rotate(360deg); }}
  
  @media print {
    body {
      background: white;
      color: black;
      display: block;
      padding: 20px;
      overflow: visible;
    }
    .sidebar, .toolbar {display: none !important;}
    .main {width: 100%; display: block;}
    .canvas {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 0;
    }
    .table-card {
      background: white;
      border: 1px solid #ccc;
      color: black;
      page-break-inside: avoid;
    }
    .round {
      background: #f0f0f0;
      border-color: #ccc;
      color: black;
    }
    .chair {
      background: #f0f0f0;
      border-color: #ccc;
      color: black;
    }
    .chair.empty {display: none;}
    .table-footer {display: none;}
  }
  
  @media (max-width:920px){ 
    body{
      flex-direction:column; 
      overflow:auto; 
      padding:10px
    } 
    .sidebar{
      width:auto; 
      max-width:none;
      height: auto;
      max-height: 80vh;
    } 
    .canvas{grid-template-columns:repeat(1, minmax(260px,1fr))} 
  }
</style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  
  <div class="loading-indicator" id="loadingIndicator">
    <div class="loading-spinner"></div>
    <span id="loadingMessage">处理中...</span>
  </div>
  
  <div class="modal-backdrop" id="conflictModal">
    <div class="modal">
      <h2><i class="fas fa-exclamation-triangle"></i> 检测到数据冲突</h2>
      <p>其他人也修改了这份座位表，您需要选择如何处理：</p>
      
      <div id="conflictDetails"></div>
      
      <div class="modal-buttons">
        <button class="btn ghost" id="keepMineBtn">保留我的更改</button>
        <button class="btn ghost" id="takeTheirsBtn">采用他人更改</button>
        <button class="btn" id="mergeChangesBtn">合并更改</button>
      </div>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-section">
      <h1><i class="fas fa-users"></i> 宾客管理</h1>
      <input id="search" class="search" type="text" placeholder="搜索姓名…" />
      
      <div class="category-selector" id="categoryFilter">
        <div class="category-btn active" data-category="all">全部</div>
        <div class="category-btn family" data-category="family">家人</div>
        <div class="category-btn friend" data-category="friend">朋友</div>
        <div class="category-btn colleague" data-category="colleague">同事</div>
        <div class="category-btn other" data-category="other">其他</div>
      </div>
      
      <div class="filter-result" id="filterResult">
        <span>显示全部未入座宾客</span>
        <span id="filterCount">0人</span>
      </div>
      
      <textarea id="bulkNames" rows="4" placeholder="批量粘贴姓名：每行一个；可带人数，如“张三 2”表示张三一行共2人；可带备注，如“李四 4（同事）”"></textarea>
      
      <div>
        <label style="font-size:12px; color:var(--muted); margin-bottom:4px; display:block;">添加为：</label>
        <select id="guestCategory" style="width:100%; padding:8px; border-radius:8px; background:#0f1330; border:1px solid var(--border); color:var(--text);">
          <option value="family">家人</option>
          <option value="friend">朋友</option>
          <option value="colleague">同事</option>
          <option value="other">其他</option>
        </select>
      </div>
      
      <div class="row">
        <button class="btn" id="addGuestsBtn">
          <i class="fas fa-user-plus"></i> 添加到名单
        </button>
        <button class="btn ghost" id="clearGuestsBtn" title="仅清空未入座列表，不影响桌上已入座">
          <i class="fas fa-trash"></i> 清空
        </button>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h1><i class="fas fa-utensils"></i> 桌位管理</h1>
      <div class="row">
        <input id="tableName" type="text" placeholder="桌名（如：1号桌）">
        <input id="tableCap" type="number" min="1" value="10" title="座位数">
        <button class="btn" id="addTableBtn">
          <i class="fas fa-plus-square"></i> 新增
        </button>
      </div>
      
      <div class="row">
        <button class="btn" id="autoSeatBtn" title="按桌容量从上到下自动排座">
          <i class="fas fa-magic"></i> 自动排座
        </button>
        <button class="btn ghost" id="shuffleBtn" title="随机打散未入座名单">
          <i class="fas fa-random"></i> 打散
        </button>
      </div>
      
      <div style="margin-top:8px; padding:8px; background:rgba(0,0,0,0.1); border-radius:8px;">
        <label style="font-size:12px; color:var(--muted); display:block; margin-bottom:4px;">自动排座选项：</label>
        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
          <input type="checkbox" id="groupByCategory" checked>
          <label for="groupByCategory" style="font-size:12px;">按类别分组</label>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="optimizeSeating">
          <label for="optimizeSeating" style="font-size:12px;">优化座位利用率</label>
        </div>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h1><i class="fas fa-layer-group"></i> 批量操作</h1>
      <div class="row">
        <select id="batchTableSelect" style="flex:1; padding:8px; border-radius:8px; background:#0f1330; border:1px solid var(--border); color:var(--text);">
          <option value="">选择目标桌...</option>
        </select>
        <button class="btn ghost" id="batchMoveBtn" title="将所有未入座宾客移动到所选桌">
          <i class="fas fa-arrow-right"></i> 移动全部
        </button>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h1><i class="fas fa-database"></i> 数据管理</h1>
      <div class="row">
        <button class="btn ghost" id="exportBtn">
          <i class="fas fa-download"></i> 导出
        </button>
        <select id="exportFormat" style="padding:8px; border-radius:8px; background:#0f1330; border:1px solid var(--border); color:var(--text);">
          <option value="json">JSON</option>
          <option value="csv">CSV</option>
        </select>
      </div>
      
      <div style="margin-top:8px;">
        <label style="font-size:12px; color:var(--muted); display:block; margin-bottom:4px;">导入：</label>
        <input id="importFile" type="file" accept=".json,.csv">
        <div id="importPreview" class="import-preview" style="display:none;"></div>
        <button class="btn ghost" id="confirmImportBtn" style="margin-top:8px; display:none;">确认导入</button>
      </div>
      
      <div class="row" style="margin-top:8px;">
        <button class="btn ghost" id="printBtn">
          <i class="fas fa-print"></i> 打印
        </button>
        <button class="btn warn" id="resetAllBtn">
          <i class="fas fa-exclamation-triangle"></i> 重置全部
        </button>
      </div>
    </div>
    
    <div class="sidebar-section guest-list-container">
      <h1><i class="fas fa-list"></i> 未入座宾客</h1>
      <div id="guestList" class="guest-list" aria-label="未入座列表"></div>
    </div>
  </aside>

  <main class="main">
    <div class="toolbar">
      <div class="pill highlight">实时协作：把下面的分享链接发给同事/亲友，大家看到的是同一份座位表。</div>
      <div class="stats" id="stats"></div>
    </div>

    <div class="toolbar" style="gap:10px">
      <div class="grid-controls">
        <span>每排桌数：</span>
        <input id="colsRange" type="range" min="1" max="8" step="1" value="3">
        <input id="colsNumber" type="number" min="1" max="8" step="1" value="3" style="width:64px">
      </div>
      <button class="btn" id="shareBtn">
        <i class="fas fa-share-alt"></i> 复制分享链接
      </button>
      <span class="pill">链接：<span id="shareTip" style="opacity:.85"></span></span>
      <span class="pill">计划ID：<code id="planIdLabel"></code></span>
      <span class="pill" id="onlineUsers">在线：0人</span>
    </div>

    <div id="canvas" class="canvas" aria-label="桌面画布"></div>
  </main>

  <script src="Seating-Plan.js"></script>
</body>
</html>
